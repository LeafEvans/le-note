# 文件管理

## 初识文件管理

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622005555761.png" alt="image-20250622005555761" style="zoom:40%;" />

计算机中存放了各种各样的文件，一个文件有哪些属性？

<span style="color:#F7374F">**文件内部**</span>的数据应该怎样组织起来？<span style="color:#F7374F">**文件之间**</span>又应该又应该怎么组织起来？

从下往上看，OS 应提供哪些功能，才能方便用户、应用程序使用文件？

从上往下看，文件数据应该怎么存放在外存（磁盘）上？

### 文件的属性

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622010222843.png" alt="image-20250622010222843" style="zoom:33%;" />



<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622010326986.png" alt="image-20250622010326986" style="zoom:33%;" />

- <span style="color:#27548A">**文件名**</span>：由创建文件的用户决定文件名，主要是为了方便用户找到文件，<span style="color:#27548A">同一目录下不允许有**重名文件**</span>

- **<span style="color:#27548A">标识符</span>**：一个系统内的各文件标识符唯一，对用户来说毫无可读性，因此标识符只是操作系统用于区分各个文件的一种**内部名称**

- <span style="color:#27548A">**类型**</span>：指明文件的类型

- <span style="color:#27548A">**位置**</span>：文件存放的路径（让**用户**使用）、在外存中的地址（**操作系统**使用，对用户不可见）

- **<span style="color:#27548A">大小</span>**：指明文件大小

- <span style="color:#27548A;font-weight:bold">创建时间、上次修改时间、文件所有者信息</span>

- <span style="color:#27548A;font-weight:bold">保护信息</span>：对文件进行保护的**访问控制信息**

### 文件内部的组织

<img src="/home/leafevans/.config/Typora/typora-user-images/image-20250622010853360.png" alt="image-20250622010853360" style="zoom:33%;" />



<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220113.png" style="zoom:45%;" />

### 文件外部的组织

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622011502891.png" style="zoom:33%;" />

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220118.png" style="zoom:33%;" />

所谓的**目录**其实就是**文件夹**。

用户可以自己创建一层一层的目录，各层目录中存放相应的文件；系统中的各个文件就通过一层一层的目录合理有序地组织起来了。（目录其实也是一种特殊的有结构文件，由记录组成）

### 操作系统向上提供功能

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622012422197.png" alt="image-20250622012422197" style="zoom:33%;" />

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622012457286.png" alt="image-20250622012457286" style="zoom:33%;" />

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622070235139.png" alt="image-20250622070235139" style="zoom:33%;" />

- 可以<span style="color:#FF9B17">**创建文件**</span>。（点击新建后，图形化交互进程在背后调用了 **`create` 系统调用**）
- 可以<span style="color:#F7374F;font-weight:bold">读文件</span>，将文件数据读入内存，才能让 CPU 处理。（双击后，**记事本**应用程序通过操作系统提供的<span style="color:#F7374F">**读文件**</span>功能，即 **`read` 系统调用**，将文件数据从外存读入内存，并显示在屏幕上）
- 可以<span style="color:#27548A;font-weight:bold">写文件</span>，将更改过的文件数据写回外存（我们在**记事本**应用程序中编辑文件内容，点击**保存**后，**记事本**应用程序通过操作系统提供的<span style="color:#27548A;font-weight:bold">写文件</span>功能，即 <span style="color:#27548A">**`write` 系统调用**</span>，将文件数据从内存写回外存）
- 可以<span style="color:#693382; font-weight:bold">删除文件</span>（点了**删除**之后，图形化交互进程通过操作系统提供的<span style="color:#693382;font-weight:bold">删除文件</span>功能，即 <span style="color:#693382;font-weight:bold">`delete` 系统调用</span>，将文件数据从外存中删除）

![](https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220707.svg)

读/写文件之前，需要使用上述**打开文件**；读/写文件之后，需要使用上述**关闭文件**。

可用几个基本操作完成更复杂的操作，比如：**复制文件**是先创建一个新的空文件，再把源文件读入内存，再将内存中的数据写到新文件中。

### 文件在外存的存放方式

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622071120380.png" alt="image-20250622071120380" style="zoom:33%;" />

与内存一样，外存也是由一个个存储单元组成的，每个存储单元可以存储一定量的数据（如 1B）。每个存储单元对应一个物理地址。

类似于内存分为一个个**内存块**，外存会分为一个个**块/磁盘块/物理块**。每个磁盘块的大小是相等的，每块一般包含 2 的整数幂个地址（如本例中，一块包含 $2^{10}$ 个地址，即 1KB）。同样类似的是，文件的逻辑地址也可以分为 `(逻辑块号, 块内地址)`，操作系统同样需要将逻辑地址转换为外存的物理地址 `(物理块号, 块内地址)` 的形式。块内地址的位数**取决于磁盘块的大小**。

操作系统以**块**为单位为文件分配存储空间（类似于页框），因此即使一个文件大小只有 10B，但它依然需要占用 1KB 的磁盘块。外存中的数据读入内存时同样以块为单位。

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622071515888.png" alt="image-20250622071515888" style="zoom: 33%;" />

### 操作系统实现的其他文件管理功能

- **文件共享**：使多个用户可以共享使用一个文件
- **文件保护**：如何保证不同的用户对文件有不同的操作权限

---

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220824.png" style="zoom:50%;" />

## 文件的逻辑结构

**知识总览**：

![](https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220743.svg)

所谓的<span style="color:#007074;font-weight:bold">逻辑结构</span>，就是指在用户看来，文件内部的数据应该是**如何组织**起来的；而<span style="color:#007074;font-weight:bold">物理结构</span>指的是在操作系统看来，文件的数据是**如何存放**在外存中的。

类似于数据结构的**逻辑结构**和**物理结构**，如<span style="color:#EB5B00">**线性表**</span>就是一种逻辑结构；在用户角度看来，线性表就是一组有先后关系的元素序列，如 `a, b, c, d, e`。

 <span style="color:#B03052;font-weight:bold">线性表</span>这种逻辑结构可以用**不同的物理结构**实现，如：<u>顺序表/链表</u>。顺序表的各个元素在逻辑上相邻，在物理上也相邻；而链表的各个元素在物理上可以是不相邻的。因此，**顺序表**可以实现<span style="color:#255F38">**随机访问**</span>，而**链表**无法实现随机访问。

可见，算法的具体实现与**逻辑结构、物理结构**都有关。（文件也一样，文件操作的具体实现与文件的**逻辑结构、物理结构**都有关）

### 无结构文件

按文件是否有结构分类，可以分为无结构文件、有结构文件两种。

<span style="color:#4D55CC; font-weight:bold">无结构文件</span>：文件内部的数据就是一系列二进制流或字符流组成，又称**流式文件**。如：Windows 操作系统中的 .txt 文件。

文件内部的数据其实就是一系列字符流，没有明显的结构特性；因此也不用探讨无结构文件的**逻辑结构**问题。

### 有结构文件

<span style="color:#E53888;font-weight:bold">有结构文件</span>：由一组相似的记录组成，又称**记录式文件**，每条记录又若千个数据项组成，例如，数据库表文件。一般来说，每条记录有一个数据项可作为<span style="color:#AA60C8">关键字</span>（作为识别不同记录的 ID）。

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622080614903.png" alt="image-20250622080614903" style="zoom:50%;" />

根据各条记录的长度（占用的存储空间）是否相等，有可分为<span style="color:#1B4D3E; font-weight:bold">定长记录</span>和<span style="color:#1B4D3E; font-weight:bold">可变长记录</span>。

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622080903494.png" alt="image-20250622080903494" style="zoom:50%;" />

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622081023355.png" alt="image-20250622081023355" style="zoom:33%;" />

根据有结构文件中的各条记录在逻辑上如何组织，可以分为三类：

![](https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220756.svg)

### 顺序文件

<span style="color:#3D8D7A; font-weight:bold">顺序文件</span>：文件中的记录一个接一个地顺序排列（逻辑上），记录可以是<span style="color:#3A7D44">定长</span>的或<span style="color:#3A7D44">可变长</span>的，各个记录在物理上可以<span style="color:#3A7D44">顺序存储</span>或<span style="color:#3A7D44">链式存储</span>。

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622081906527.png" alt="image-20250622081906527" style="zoom:33%;" />

![](https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220757.svg)

串结构通常按照记录的存入时间决定记录的顺序。

假设已经知道了文件的起始地址（也就是第一个记录存放的位置），则：

- 能否快速找到第 i 个记录对应的地址？（即能否实现**随机存取**）
- 能否快速找到某个关键字对应的记录存放位置？

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-202506220828.png" style="zoom:50%;" />

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622083304208.png" alt="image-20250622083304208" style="zoom:33%;" />

<span style="color:#FF2DF1;font-weight:bold">结论</span>：定长记录的顺序文件，若物理上采用**顺序存储**，则可实现**随机存取**；若能再保证**记录的顺序结构**，则可实现**快速检索**。（即根据关键字快速找到对应记录）

> **注意**：
>
> 一般来说，**顺序文件**指的是<span style="color:#1F7D53">物理上顺序存储的顺序文件</span>。

可见，顺序文件的<span style="color:#FFA725">**缺点**</span>是<span style="color:#FFA725">**增加/删除**一个记录比较困难</span>。（如果是串结构则相对简单）

### 索引文件

对于可变长记录文件，要找到第 $i$ 个记录，必须先顺序第查找前 $i-1$ 个记录但是很多应用场景中又必须使用可变长记录。如何解决这个问题？

<img src="https://leafalice-image.oss-cn-hangzhou.aliyuncs.com/img/image-20250622084548795.png" alt="image-20250622084548795" style="zoom:33%;" />

<span style="color:#4D55CC">**索引表**</span>本身是<span style="color:#4D55CC">定长记录的顺序文件</span>。因此可以快速找到第 $i$ 个记录对应的索引项。可将关键字作为索引号内容，若按关键字顺序排列，则还可以支持按照关键字折半查找

每当要增加/删除一个记录时，需要对索引表进行修改。由于索引文件有很快的检索速度，因此<span style="color:#2DAA9E; font-weight:bold">主要用于对信息处理的及时性要求比较高的场合</span>。

另外，<span style="color:#AC1754;font-weight:bold">可以用不同的数据项建立多个索引表</span>。如学生信息表中，可用关键字**学号**建立一张索引表；也可用**姓名**建立一张索引表，这样就可以根据**姓名**快速地检索文件了。（例如，SQL 就支持根据某个数据项建立索引的功能）

### 索引顺序文件