# 网络层

<img src="../images/image-202512240004.webp" style="zoom:60%;" />

<u>**网络层**</u>为<u>传输层</u>提供服务，将传输层的数据封装成**“IP 数据报”**。网络中的路由器根据 IP 数据报首部中的*<u>源 IP 地址</u>*、<u>_目的 IP 地址_</u>进行“分组转发”。因此，网络层实现了**“主机到主机”**的传输。

<u>数据链路层</u>为<u>网络层</u>提供服务，将网络层的 **IP 数据报（分组）**封装成**_<u>帧</u>_**，传输给下一个**相邻结点**。

<img src="../images/image-202512240017.webp" style="zoom:50%;" />

IP 地址，用 32bit 表示，有 <u>01101110</u> <u>10111111</u> <u>10110101</u> <u>00110001</u>。

常以 **8bit** 为一族，记为十进制数。（显然每个部分的合法范围为 <u>0~255</u>）

## 网络层的功能

**知识总览**：

<img src="../images/image-202512240026.webp" style="zoom:50%;" />

<img src="../images/image-202512240049.webp" style="zoom:50%;" />

> [!tip]
>
> - 接入网络的每台主机至少拥有一个 IP 地址
> - 通常，路由器的每个接口都需要分配一个 IP 地址（最新技术标准已经取消了这个强制要求）

### IPv4 分组

### 各种协议之间的服务关系

<img src="../images/image-202512240053.webp" style="zoom:50%;" />

**IP 协议**（Internet Protocal，网际协议）是<u>互联网的核心</u>。

**ARP 协议**用于查询同一网络中的 <主机 IP 地址, MAC 地址> 之间的映射关系。

**ICMP 协议**用于网络层实体时间相互通知“异常事件”。

**IGMP 协议**用于实现 IP 组播。

### IP 数据报（IP 分组）的格式

<img src="../images/image-202512240103.webp" style="zoom:50%;" />

<img src="../images/image-202512240137.webp" style="zoom:50%;" />

<img src="../images/image-202512240206.webp" style="zoom:50%;" />

TTL 的初始值通常由**源主机**设置。

每经过一个路由器，路由器就将 TTL 减 1，如果 TTL 减到 0，就直接丢弃分组，并向源主机发送 ICMP 报文。

> [!tip]
>
> ICMP 报文用于通知一个节点发生了某种“异常”。

---

<img src="../images/image-202512240105.webp" style="zoom:50%;" />

### IP 数据报的“分片”问题

<img src="../images/image-202512240111.webp" style="zoom:50%;" />

**重要概念**：一个链路层数据帧能承载的最大数据量称为<u>最大传送单元（MTU）</u>。如以太网的 MTU = 1500B。

若一个 IP 数据报的总长度超出了下一段链路的 MTU，就需要分片。

<img src="../images/image-202512240118.webp" style="zoom:50%;" />

<img src="../images/image-202512240119.webp" style="zoom:50%;" />

> [!tip]
>
> 每个分片都是一个可以被单独转发的 IP 数据报，都包含首部。

- IP 数据报的<span style="color:#EA2264; font-weight:bold">“分片”</span>可能在<span style="color:#EA2264; font-weight:bold">源主机、或任何一个路由器</span>中发生。
- 只有<span style="color:#33A1E0; font-weight:bold">目的主机</span>才会对分片进行<span style="color:#33A1E0; font-weight:bold">“重组”</span>。
- 各分片有可能乱序到达目的主机。
- 由于首部的“片偏移”字段是以 <u>×8B</u> 为单位，因此，**除了<u>最后一个分片</u>外，其他每个分片的数据部分必须是 8B 的整数倍**。

### IP 数据报的生存时间“TTL”（可达示例）

<img src="../images/image-202512240201.webp" style="zoom:50%;" />

### IP 数据报的生存时间“TTL”（不可达示例）

<img src="../images/image-202512240158.webp" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202512240209.jpg" style="zoom:50%;" />

## IP 地址（最初的分类方案）

### IP 数据报（IP 分组）的格式

<img src="../images/image-202512240216.jpg" style="zoom:50%;" />

### 最初的 IP 地址分类方案

<img src="../images/image-202512240217.jpg" style="zoom:50%;" />

**时代背景**：IPv4 协议是 1981 年发明的，当时只有政府、学校、军队等大机构会使用互联网。完全没有预料到互联网用户会迎来爆炸性增长。因此 IPv4 协议中，地址位数仅设计了 32bit（$2^{32} \approx 42$ 亿）。

> [!tip]
>
> IP 地址资源由 ICANN（互联网名字和数字分配机构）进行分配（有偿租用）。

<img src="../images/image-202512240220.jpg" style="zoom:50%;" />

- 在那个年代，要求**每台主机每个路由器接口被分配的 IP 地址都是全球唯一的**。
- **路由器和路由器连接的接口可以不分配 IP 地址**，但**路由器和其他节点连接的接口必须分配 IP 地址**
- 从属于**<u>同一个网络</u>的所有主机、路由器接口的 IP 地址“网络号”都相同**
- 当一台新主机接入网络时，需要给它分配一个 IP 地址、并配置“默认网关”

<img src="../images/image-202512240709.jpg" style="zoom:50%;" />

### 一些特殊用途的 IP 地址

| 网络号 |          主机号          | 作为分组源地址？ | 作为分组目的地址？ |                      代表的含义                      |
| :----: | :----------------------: | :--------------: | :----------------: | :--------------------------------------------------: |
|   Y    |           全 0           |        ×         |         ×          |      表示整个网络本身（只能用于路由表、转发表）      |
|   Y    |           全 1           |        ×         |         ✓          |           向网络号为 Y 的网络广播 IP 分组            |
|   0    |            Y             |        ✓         |         ×          |            表示本网络中主机号为 Y 的主机             |
|  全 0  |           全 0           |        ✓         |         ×          |       本网络上的本主机（会在 DHCP 协议中使用）       |
|  全 1  |           全 1           |        ×         |         ✓          |                 向本网络广播 IP 分组                 |
|  127   | 非全 0 或非全 1 的任何数 |        ✓         |         ✓          | 环回自检地址。表示一台主机本身，用于本地软件环回测试 |

> [!tip]
>
> <span style="color:#ED3F27">以上这些特殊地址不可指派给网络中的任何一台主机或路由器“私用”。</span>

**重要结论**：前 2 行说明，若一个网络中，<span style="color:#006A67; font-weight:bold">主机号占 N bit</span>，那么在这个网络中，<span style="color:#006A67; font-weight:bold">最多支持 2^N^ - 2 台</span>主机 & 路由器。

## 子网划分 & 子网掩码

**知识总览**：

<img src="../images/image-202512240743.jpg" style="zoom:50%;" />

### 暂未使用子网划分技术

<img src="../images/image-202512240748.jpg" style="zoom: 67%;" />

### 学校网络使用了子网划分技术（划分为两个子网道计算机）

<img src="../images/image-202512240800.jpg" style="zoom: 67%;" />

### 学校网络使用了子网划分技术（划分为 4 个子网）

<img src="../images/image-202512240805.jpg" style="zoom: 67%;" />

<img src="../images/image-202512240907.jpg" style="zoom:50%;" />

<img src="../images/image-202512240909.jpg" style="zoom:50%;" />

### 子网掩码的 CIDR 记法

<img src="../images/image-202512240915.jpg" style="zoom: 67%;" />

## 无分类编制 CIDR

**知识总览**：

<img src="../images/image-202512240921.jpg" style="zoom:50%;" />

**时代背景**：1993 年推出**无分类编址 CIDR**，当时互联网在民用领域大放异彩，由于每台主机都至少要消耗一个全球唯一的 IP 地址。**_<u>IP 地址资源告急。</u>_**

### 传统的 IP 地址划分方案有什么缺陷？

<img src="../images/image-202512240923.jpg" style="zoom:50%;" />

- 一个 A 类地址块包含 2^24^ = 16,777,216 个 IP 地址
- 一个 B 类地址块包含 2^16^ = 65536 个 IP 地址
- 一个 C 类地址块包含 2^8^ = 256 个 IP 地址

例如某单位有 2000 台主机想要联网，就不得不申请一个 B 类地址块。

<span style="color:#6F00FF; font-weight:bold">IP 地址资源分配不灵活，利用率低，有限的 IP 地址资源将很快耗尽。</span>

### 无分类编址 CIDR

<img src="../images/image-202512240929.jpg" style="zoom:50%;" />

例如某单位有 2000 台主机想要联网，IP 地址管理机构可以给它分配一个 <span style="color:#E9A319">21bit 网络前缀</span>的 <span style="color:#5EABD6">CIDR 地址块</span>。

<img src="../images/image-202512240935.jpg" style="zoom:50%;" />

### 定长子网划分、变长子网划分

一个单位获得 CIDR 地址块后，可以把它划分为多个子网。

<span style="color:#9B177E; font-weight:bold">定长子网划分</span>：在一个 CIDR 地址块中，把主机号前 k bit 抠出来作为定长子网号（与传统的子网划分技术同理），这样即可划分出 2^k^ 个子网（每个子网包含的 IP 地址块大小相等）。

<span style="color:#06923E; font-weight:bold">变长网划分</span>（子网划分更加灵活）：在一个 CIDR 地址块中，划分子网时，<span style="color:#C83F12">子网号长度不固定</span>（每个子网包含的 IP 地址块大小不同）。

#### 传统的“定长子网划分”方案有什么缺陷？

假设某学校申请了一个 IP 地址块：166.1.X.X。

<img src="../images/image-202512240944.jpg" style="zoom:50%;" />

<span style="color:#B22222; font-weight:bold">定长子网划分</span>：在申请一个 IP 地址块后，将 <span style="color:#FF7D29">n bit 主机号</span>的<span style="color:#0ABAB5">前 k bit</span> 抠出来作为<span style="color:#B22222">子网号</span>，这样即可划分出 <span style="color:#0ABAB5">2^k^ 个定长子网</span>（每个子网包含的 IP 地址块大小相等，都<span style="color:#B22222">包含 2^n-k^ 个 IP 地址</span>）。

**缺点**：每个子网<u>_均一样大_</u>，不够灵活，IP 地址利用率低，浪费有限的 IP 地址资源。

### 无分类编址 CIDR、变长子网划分的应用

<img src="../images/image-202512240956.jpg" style="zoom:50%;" />

子网划分更加灵活，且方便地址资源的分层级管理。

---

东海帝皇开了一家公司，叫“哈基米电信”，希望成为村里的 ISP。“哈基米电信”花重金向上一级 IP 地址管理机构租用了一个 CIDR 地址块 <span style="color:#B33791">128.14.32.128/27</span>（<span style="color:#B33791"><u>10000000.00001110.00100000.100</u>00000</span>）。

1. 请问哈基米电信拥有多少个 IP 地址资源？

   2^5^ = 32。

2. 村里的年轻人诗歌剧想开网吧，于是向哈基米购买宽带服务。整个网吧有 12 台电脑，每台电脑需要分配一个 IP 地址，且所有电脑属于同一个子网。

   <img src="../images/image-202512241011.png" style="zoom:50%;" />

3. 特别周家里很有钱，有 5 口人，人手一台电脑，每台电脑需要分配一个 IP 地址，所有电脑要组成一个子网。

   <img src="../images/image-202512241017.png" style="zoom:50%;" />

4. 黄金船家里只有一台电脑，需要从哈基米电信的路由器拉一条<span style="color:#FF3F33">“路由器直连主机”的点对点链路</span>。

   <img src="../images/image-202512241020.png" style="zoom:50%;" />

   <img src="../images/image-202512241024.png" style="zoom:50%;" />

   <span style="color:#CD5656">点对点链路是一个最小的子网，至少需要保留 <span style="font-weight:bold"><u>2 bit</u></span> 作为主机号。</span>

   <span style="color:#F564A9">因为主机号全 1、全 0 不能分配给节点，因此仅 1 bit 主机号是不够用的。</span>

请为哈基米电信设计一个地址分配方案，并配置哈基米电信的路由器转发表，确保诗歌剧的网吧、特别周家、黄金船家可以接入 Internet。

|     目的网络     | 转发接口 |
| :--------------: | :------: |
| 128.14.32.128/28 |    F1    |
| 128.14.32.144/29 |    F2    |
| 128.14.32.152/30 |    F3    |
|    0.0.0.0/0     |    F0    |

<span style="color:#7D0A0A; font-weight:bold">CIDR 地址块的子网划分技巧</span>：可以利用类似于<span style="color:#7D0A0A">“从根到叶构造二叉哈夫曼树”</span>的技巧。

- <span style="color:#00879E">原始 CIDR 地址块</span>作为<span style="color:#00879E">根节点</span>（假设可以自由分配的<span style="color:#E07A5F">主机号占 h bit</span>）。
- 每个<span style="color:#2D336B">分支节点必须同时拥有左右孩子</span>，<span style="color:#E52020">左 0、右 1</span>（反过来也行）。
- 每个<span style="color:#DD88CF">叶子结点</span>对应一个<span style="color:#DD88CF">子网</span>，根据<span style="color:#E52020">根节点到达叶子结点的路径</span>来分析<span style="color:#DD88CF">子网</span>对应的 <span style="color:#DD88CF">IP 地址块范围</span>。
- <span style="color:#5B913B">整棵树的高度不能超过 h - 1</span>（因为即便最小的子网也至少要保留 2bit 主机号）。

<img src="../images/image-202512241044.png" style="zoom:50%;" />

---

<img src="../images/image-202512241058.png" style="zoom:50%;" />

<img src="../images/image-202512241101.png" style="zoom:50%;" />

2^7^ = 128，因此需要使用 7 bit 作为定长子网号。

每个子网中，主机号占 16 - 7 = 9bit。

可分配的 IP 地址个数为 2^9^ - 2 = 510。（主机号全 0、全 1 不能分配给某个节点私用）

---

<img src="../images/image-202512241105.png" style="zoom:50%;" />

<img src="../images/image-202512241104.png" style="zoom:50%;" />

- 要划分 5 个子网，意味着构造的二叉哈夫曼树包含 5 个叶节点。
- 要让 1 个子网尽可能的小，就要让一个叶子节点尽可能的深。
- 最深的叶子与根节点的距离为 4，意味着最小的子网，需要从原 CIDR 地址块中，拿出 4bit 作为子网号，剩下 12 - 4 = 8bit 作为<u>_该子网的主机号_</u>。
- 最小子网可分配的 IP 地址数为 **2^8^ - 2 = 254**。

<img src="../images/image-202512241107.png" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202512241112.png" style="zoom:50%;" />

## 路由聚合

<img src="../images/image-202512241120.webp" style="zoom:50%;" />

对于一个路由转发表，如果几条路由表项的<span style="color:#16C47F; font-weight:bold">转发接口相同</span>，<span style="color:#DF6D2D; font-weight:bold">部分网络前缀也相同</span>，那么可以<span style="color:#001A6E">将这几条路由表项聚合为一条</span>。这种地址的聚合称为<span style="color:#001A6E"><u>路由聚合</u></span>，也称<span style="color:#001A6E"><u>构成超网</u></span>。

- 路由聚合可以**减少路由表的大小**。
- 路由聚合可能**会引入额外的无效地址**。如 128.14.32.156/30。
- 表更小，查询更快。
- 上图中“咸鱼电信路由器转发表”中，前三个表项转发接口不同，不可进行路由聚合。

### 最长前缀匹配原则

<img src="../images/image-202512241215.webp" style="zoom:50%;" />

**假设**：县里的电信路由器收到一个来自互联网的 IP 数据包，目的 IP 地址为 128.14.32.131 = 10000000.00001110.00100000.10000011。

<img src="../images/image-202512241217.webp" style="zoom:50%;" />

根据最长前缀匹配原则，命中表项 ②，从 **G3 接口**转发出去。

---

**假设**：县里的电信服务器收到一个来自互联网的 IP 数据包，目的 IP 地址为 128.14.32.153。

<img src="../images/image-202512241222.webp" style="zoom:50%;" />

根据最长前缀匹配原则，表项 ① 匹配的前缀最长，从 **G1 接口**转发出去。

---

<img src="../images/image-202512240907.jpg" style="zoom:50%;" />

采用 CIDR 技术后，过程类似。

<img src="../images/image-202512240909.jpg" style="zoom:50%;" />

采用 CIDR 技术后，由于“<u>路由聚合</u>”，一个 IP 地址在转发表中可能会匹配多个表项，此时应使用**<u>最长前缀匹配原则</u>**。

**路由聚合**：对于一个路由转发表，若几条路由表项的**转发接口相同**，**部分网络前缀也相同**，那么可以<u>_将这几条路由表项聚合为一条_</u>。

<img src="../images/image-202512241229.webp" style="zoom: 80%;" />

## 网络地址转换 NAT

**知识总览**：

<img src="../images/image-202512251047.webp" style="zoom:50%;" />

### 传输层“端口号”的概念

<img src="../images/image-202512251051.png" style="zoom:50%;" />

<span style="color:#FF0000">网络层</span>实现了“<u>主机到主机</u>”的通信。网络层在 IP 数据报的首部，指明 <span style="color:#FF0000">源 IP 地址、目的 IP 地址</span>。

<span style="color:#3B9797">传输层</span>实现了“<u>端到端</u>”（<u>进程到进程</u>）的通信。传输层在 TCP（或 UDP）报文段的首部，指明<span style="color:#3B9797">源端口、目的端口</span>。

### 数据的传输过程（垂直视角）

<img src="../images/image-202512251105.png" style="zoom:50%;" />

### 如何缓解 IP 地址不够用的问题？

IP 地址 32bit，2^32^ ≈ 42 亿，如果每台主机都要消耗一个全球唯一的 IP 地址，显然不够用。

<img src="../images/image-202512251118.png" style="zoom:50%;" />

<img src="../images/image-202512251128.png" style="zoom:50%;" />

<img src="../images/image-202512251142.png" style="zoom:50%;" />

## 地址解析协议 ARP

### 各种协议之间的服务关系

<img src="../images/image-202512251350.jpg" style="zoom:50%;" />

<span style="color:#3B9797">IP 协议（Internet Protocol，网际协议）是互联网的核心。</span>

<span style="color:#E9762B">ABP 协议</span>用于查询同一网络的 <IP 地址, MAC 地址> 之间的映射关系。

ICMP 协议用于网络层实体之间相互通知“异常事件”。

IGMP 协议用于 IP 组播。

### 回顾：以太网 MAC 帧

<img src="../images/image-202512251355.jpg" style="zoom:50%;" />

<img src="../images/image-202512281211.webp" style="zoom:50%;" />

### 拓展：ARP 分组的格式

<img src="../images/image-202512281338.webp" style="zoom:50%;" />

## 动态主机配置协议 DHCP

**知识总览**：

<img src="../images/image-202512281603.webp" style="zoom:50%;" />

### 各种协议之间的关系

<img src="../images/image-202512251350.jpg" style="zoom:50%;" />

<span style="color:#F96E5B; font-weight:bold">动态主机配置协议</span>（Dynamic Host Configuration Protocol, <span style="color:#5A7ACD">DHCP</span>）常用于给主机动态分配 IP 地址、配置子网掩码、默认网关等网络相关的参数。

<span style="color:#16476A">DHCP 是应用层协议，使用 UDP 提高的服务。</span>

### DHCP 报文在协议栈中的位置

<img src="../images/image-202512281610.webp" style="zoom:50%;" />

![](../images/image-202512281615.webp)

<img src="../images/image-202512281619.png" style="zoom:50%;" />

<img src="../images/image-202512281627.webp" style="zoom:50%;" />

<img src="../images/image-202512281706.webp" style="zoom:50%;" />

<img src="../images/image-202512281705.webp" style="zoom:50%;" />

<img src="../images/image-202512281704.webp" style="zoom:50%;" />

<img src="../images/image-202512281710.webp" style="zoom:50%;" />

<img src="../images/image-202512281712.webp" style="zoom:50%;" />

## ICMP 网际控制报文协议。

网际控制报文协议（Internet Control Message Protocol）。

**知识总览**：

<img src="../images/image-202512281717.webp" style="zoom:50%;" />

### 各种协议之间的关系

<img src="../images/image-202512251350.jpg" style="zoom:50%;" />

<span style="color:#4B9DA9">ICMP 协议属于网络层。</span>

<span style="color:#4B9DA9">IP 协议为 ICMP 协议提供服务。</span>

ICMP 协议用于主机、路由器之间相互通知网络中发生的“异常事件”。

### ICMP 报文、IP 数据包之间的关系

<img src="../images/image-202512281721.webp" style="zoom:50%;" />

### ICMP 差错报告报文：终点不可达

<img src="../images/image-202512281727.webp" style="zoom:50%;" />

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

- 当主机 A（源地址：128.14.32.131）向目的地址 166.1.128.3 发送 IP 数据报时，该数据包经过多跳路由转发到达某学校局域网的边缘路由器。路由器在本地网络中无法找到目的主机（目的 IP 地址不可达），于是生成一个 ICMP 终点不可达（Destination Unreachable）差错报文。该 ICMP 报文包含原始 IP 数据报的首部及部分数据，并明确指示目的网络不可达的原因。随后，路由器将此 ICMP 报文封装为新的 IP 数据报（源地址为路由器接口地址，目的地址为主机 A 的地址），通过反向路径逐渐转发回主机 A。主机 A 收到并解析该 ICMP 报文后，即可获知数据传输失败的具体原因。
- 当主机 A 想主机 B 的 6666 端口发送 TCP/UDP 数据报时，该数据包经路由转发成功抵达主机 B。主机 B 的网络层接收 IP 数据报后，将其载荷（TCP/UDP 段）上交给传输层。然而，传输层发现本地不存在监听 6666 端口的进程，导致数据报无法完成向上层应用的交付。此时，主机 B 会生成一个 ICMP 终点不可达（Destination Unreachable）差错报文，其中类型字段 3（终点不可达），代码字段为 3（端口不可达）。该 ICMP 报文包含原始 IP 数据报的首部及前 8 字节载荷，封装成新的 IP 数据包后沿反向路径返回主机 A。主机 A 收到后即可获知目标端口不存在对应进程，从而进行相应的错误处理。

### ICMP 差错报告报文：时间超过

<img src="../images/image-202512282132.webp" style="zoom:50%;" />

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

- 当主机 A 向主机 B 发送 IP 数据报时，需要设置初始 TTL（Time To Live）值。假设初始 TTL 值为 2，该数据包在传输过程中每经过一台路由器，TTL 值递减 1。当数据包到达第二台路由器时，TTL 值减至 0，根据 IP 协议规定，路由器将丢弃该数据包，并向源主机 A 发送 ICMP 超时（Time Exceeded）差错报文。该 ICMP 报文的类型字段为 11（超时），代码字段为 0（TTL exceed in transit），其中包含原始 IP 数据包的首部及前 8 字节载荷。此 ICMP 报文被封装为新的 IP 数据报，沿反向路径逐跳转发回主机 A。主机 A 收到后解析该报文，即可获知数据包因 TTL 过期而被丢弃，从而诊断网络路径过长或路由环路等问题。
- 当主机 A 向主机 B 发送一个大型 IP 数据报时，若其长度超过传输路径中某链路的 MTU（最大传输单元），该数据包将在路由器处被分片传输。假设原始数据被划分为 3 个分片，其中分片 1 和分片 3 成功到达目的主机 B，而分片 2 在传输过程中丢失。根据 IP 协议规范，目的主机 B 会为重组操作启动重组计时器（通常为 30~60 秒）。若计时器超时仍未收齐所有分片，B 将丢弃已接收的分片，并向源主机 A 发送 ICMP 超时（Time Exceeded）差错报文。该 ICMP 报文的类型字段为 11，代码字段为 1（表示分片充足超时），其中包含原始 IP 数据报首部及前 8 字节载荷。主机 A 收到此 ICMP 报文后，通过解析其类型和内容，可明确获知因分片丢失导致的数据报重组失败，进而调整后续传输策略（如减少发送数据报大小或启用 MTU 发现机制）。

### ICMP 差错报告报文：参数问题

<img src="../images/image-202512282312.webp" style="zoom:50%;" />

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

当主机 A 向主机 B 发送 IP 数据报时，路由器在转发过程中会验证 IP 首部检验和以检测传输差错。若路由器检测到首部校验和错误或首部字段存在非法参数（如无效版本号、错误首部长度等），将立即丢弃该数据报，并向源主机 A 发送 ICMP 参数问题（Parameter Problem）差错报文。该 ICMP 报文的字段类型为 12，代码字段为 0（首部校验和错误）或 1（非法参数），其中包含指向出错字段的指针及原始 IP 首部信息。主机 A 接收到此 ICMP 报文后，通过解析类型、代码和指针字段，可精确定位数据报首部的错误位置及类型，从而进行相应的错误处理或重传机制。

### ICMP 差错报告报文：改变路由（重定向）

<img src="../images/image-202512282333.webp" style="zoom:50%;" />

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

当主机 A 向主机 C 发送 IP 数据报时，初始路径为：A → 默认网关 R1（128.14.32.130）→ R2（128.14.32.129）→ C。路由器 R1 在转发过程中检测到：主机 A 与 R2 位于同一子网，且 R2 是到达主机 C 的最优下一条。根据 ICMP 重定向机制，R1 会向主机 A 发送 ICMP 重定向报文（类型 5，代码 1 表示主机重定向），该报文包含原始 IP 数据报首部、目标地址 C 以及建议的下一跳地址 R2（128.14.32.129）。主机 A 接收到此报文后，更新本地路由缓存，将主机 C 的下一跳直接指向 R2。后续发往 C 的数据报将绕过默认网关 R1，直接通过 R2 转发，从而优化传输路径，减少网络跳数，提升传输效率。

### ICMP 差错报告报文：\*源点抑制

![](../images/image-202512290006.webp)

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

在特定时段（如教学高峰期），校园网络可能面临高流量压力，大量 IP 数据报汇聚至边缘路由器。当路由器的处理能力或缓冲区资源达到饱和状态时，将触发尾部丢弃（Tail Drop）机制，丢弃新到达的数据报。若主机 A 发往主机 B 的数据报在此拥塞场景下被丢弃，路由器可以依据 RFC 792 规范生成 ICMP 源点抑制报文（Type 4, Code 0），该报文包含原始 IP 数据报首部信息，指示源主机 A 降低数据发送速率。主机 A 接收后，应相应减少向该网络注入的流量，以缓解拥塞状况。

然而，现代互联网架构中，ICMP 源点抑制机制已被弃用。根据 RFC 6633 标准，网络层不再承担拥塞控制职责，而是有传输层的 TCP 协议通过端到端拥塞控制机制（如慢启动、拥塞避免、快速重传等算法）动态调整发送窗口，实现更精确、公平的流量调节。这种分层设计使拥塞控制更适应复杂网络环境，避免了网络层逐跳控制带来的拓展性问题。

### ICMP 询问报文：回送请求、回送回答

<img src="../images/image-202512290033.webp" style="zoom:50%;" />

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

当主机 A 需要检测与主机 B 之间的网络连通性时，会构造一个 ICMP Echo Request（回送请求）报文。该报文被封装在 IP 数据报中，源 IP 地址设置为主机 A 的地址，目的 IP 地址设置为主机 B 的地址。此 IP 数据报通过网络中的路由器进行逐跳转发，最终到达主机 B。

主机 B 接收到该数据报后，解析出内部的 ICMP 报文类型为 Echo Request，识别请求来源为主机 A，随即生成对应的 ICMP Echo Reply（回送应答）报文。该应答报文同样被封装为 IP 数据报，源地址为主机 B，目的地址为主机 A，并通过路由路径返回至主机 A。

当主机 A 成功接收到此 Echo Reply 报文时，即可确认 A 与 B 之间的双向网络路径畅通，数据传输正常。

### ICMP 的典型应用——Ping

<img src="../images/image-202512290101.webp" style="zoom:50%;" />

<span style="color:#FA6868">Ping</span> 基于<span style="color:#018790">回送请求报文</span>、<span style="color:#018790">回送回答报文</span>实现功能。

### ICMP 询问报文：时间戳请求、时间戳回答

<img src="../images/image-202512290105.webp" style="zoom:50%;" />

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

ICMP 时间戳请求（Timestamp Request）与时间戳回答（Timestamp Reply）的交互机制与回送请求/应答类似，但功能目的不同。当主机 A 需要获取主机 B 的时钟信息时，会向 B 发送一个时间戳请求报文。该报文中包含 A 发送请求时的原始时间戳（Originate Timestamp）。

主机 B 接收到请求后，会立即构造时间戳回答报文，其中包含 3 个关键时间信息：

1. **接收时间戳**（Receive Timestamp）：B 收到请求报文的确切时间
2. **发送时间戳**（Transmit Timestamp）：B 发送回答报文的确切时间
3. **原始时间戳**（Originate Timestamp）：从请求报文中复制的 A 的发送时间

通过分析这三个时间戳，主机 A 不仅可以验证网络连通性，还能计算网络延迟并同步时钟信息，为网络时间同步和性能监测提供数据支持。

### 不必反馈 ICMP 差错报文的情况

<img src="../images/image-202512290121.webp" style="zoom:50%;" />

<img src="../images/image-202512281728.webp" style="zoom:50%;" />

1. 当主机 A 向主机 B 发送 IP 数据报，若 B 主机在处理过程中检测到该数据报存在错误（如目的不可达、超时等），B 主机会生成相应的 ICMP 差错报文，并将其封装在新的 IP 数据报中返回给 A 主机。然而，为避免网络中出现差错报告的无限循环，ICMP 协议明确规定：**对于 ICMP 差错报文本身，不应再生成新的 ICMP 差错报文**。因此，若 B 主机返回的 ICMP 差错报文在传输过程中再次出错，A 主机不会对此错误产生二次 ICMP 报告。
2. 当主机 A 向主机 B 发送一个大型 IP 数据报时，该数据报在网络传输过程中可能被分片为多个片段。若其中多个分片在传输过程中出现错误，根据 ICMP 协议规范，主机 B 只需向主机 A 返回**单个** ICMP 差错报文，而非为每个出错的分片分别生成差错报告。这一设计有效避免了网络中因重复差错报告而导致的拥塞问题。

3. 根据 ICMP 协议规范，当检测到 IP 数据报传输错误时，差错反馈机制遵循以下原则：对于**单播传输**的数据报，接收方必须向源主机返回相应的 ICMP 差错报文；而对于**广播或多播传输**的数据报，则禁止生成 ICMP 差错报文。这一设计有效防止了在广播/多播场景下因大量差错报告而引发的网络风暴问题。

4. 根据 ICMP 协议规范，当检测到源地址为特殊保留地址的 IP 数据报存在传输异常时，网络设备**禁止生成 ICMP 差错报文**。这些特殊地址包括：

   - **回环地址**（127.0.0.0 / 8 网段）：用于本机内部通信
   - **未指定地址**（0.0.0.0）：表示无效或未配置的源地址

   此设计原则有效避免了向无效或本机地址发送差错报告所导致的资源浪费和潜在安全风险，同时防止了差错报文的无限循环传播。

### ICMP 的典型应用——Traceroute（Tracert）

<img src="../images/image-202512291011.webp" style="zoom:50%;" />

<span style="color:#AA2B1D">Traceroute</span>（Tracert） 基于<span style="color:#00B7B5">时间超过报文</span>实现功能。

> [!tip]
>
> www.bilibili.com 实际上是一个**逻辑地址**，它背后绑定了**多个物理服务器 IP**。因此网站服务器的 IP 地址会出现变化。

Traceroute（路由追踪）是一种网络诊断工具，用于探测数据包从源主机到目标主机所经过的完整网络路径。其核心原理是通过发送一系列 TTL（生存时间）值递增的探测数据包，利用路由器在 TTL 超时时返回 ICMP 超时消息的机制，逐步揭示路径上每个中间节点（hop）。

## IPv6 地址

### 从 IPv4 到 IPv6

<img src="../images/image-202601030054.webp" style="zoom:50%;" />

**IPv4**：

- 2^32^ ≈ 42 亿个地址
- 一人一个 IP 地址都不够分
- <span style="color:#E9B63B">1994 年诞生</span>的 <span style="color:#E9B63B">NAT</span> 只能缓解 IP 地址耗尽

**IPv6**：

- 2^128^ ≈ 3.4 × 10^38^ 个地址
- 平均每人可得 4.3 × 10^28^ 个地址
- <span style="color:#C66E52; font-weight:bold">IPv6 可以彻底解决 IP 地址不够用的问题</span>

<img src="../images/image-202601030106.webp" style="zoom:50%;" />

### IPv6 地址的“冒号十六进制记法”

IPv4 地址的<u>点分十进制记法</u>：总共 32bit 地址，8bit 为一段，记录为十进制，段间以小数点分隔：`11000000 10101000 00000001 00000001 -> 192.168.1.1`。

IPv6 地址的<span style="color:#FE5D26"><u>冒号十六进制记法</u></span>：总共 128bit 地址，<span style="color:#FE5D26">16bit 为一段，记录为十六进制，软件以冒号分隔</span>：

```bash
0010000000000001 0000110110111000 1000010110100011 0000000000000000
0000000000000000 1000101000101110 0000001101110000 0111001100110100
->
2001:0db8:85a3:0000:0000:8a2e:0370:7334
```

### IPv6 地址的压缩记法

**未使用压缩记法的 IPv6 地址**：2001:<span style="color:#73C7C7">0</span>db8:85a3:<span style="color:#73C7C7">000</span>0:<span style="color:#73C7C7">000</span>0:8a2e:<span style="color:#73C7C7">0</span>370:7334。

1. **去除每个分段的前导零**（每个 16 位段内的前导零可以省略）：2001:db8:85a3:0:8a2e:370:7334。

2. **用双冒号“::”替代连续出现的多个 0**：2001:db8:85a3::8a2e:370:7334。

   > [!tip]
   >
   > 一个地址中只呢出现一次双冒号，否则会产生歧义。

---

<img src="../images/image-202601030150.webp" style="zoom:50%;" />

<img src="../images/image-202601030153.webp" style="zoom:50%;" />

<img src="../images/image-202601030156.webp" style="zoom:50%;" />

### 回顾：IPv4 地址资源的分配

<img src="../images/image-202601030158.webp" style="zoom:50%;" />

### IPv6 地址的分配

<img src="../images/image-202601030200.webp" style="zoom:50%;" />

**优点**：IPv6 因为地址空间很大，所以可以划分为更多的层次。

<img src="../images/image-202601030202.webp" style="zoom:50%;" />

由于 IPv6 局域网的接口标识符位数很长，因此：

- <span style="color:#FF8383; font-weight:bold">IPv6 支持即插即用（IP 地址自动配置）</span>：一台主机接入网络后，只需向路由器确认本网络前缀，就可以给自己分配 IP 地址（通常以主机自身的 MAC 地址作为接口标识符）。
- <span style="color:#FF8383; font-weight:bold">IPv6 可以不使用 DHCP。</span>当然，在一些 IP 地址安全性要求高的地方，<span style="color:#7EACB5; font-weight:bold">也支持使用 DHCP 统一管理 IPv6 地址</span>。

### IPv6 地址的分类

|     地址类型     |                                                   二进制前缀                                                   |
| :--------------: | :------------------------------------------------------------------------------------------------------------: |
|    未指明地址    |    00...0（128 位），可记为 ::/128（<span style="color:#DD5746">表示“无地址”，类似 IPv4 的 0.0.0.0</span>）    |
|     环回地址     | 00...01（128 位），可记为 ::1/128（<span style="color:#DD5746">表示 IPv4 的 127.0.0.1，自己和自己通信</span>） |
|     多播地址     |     11111111（8 位），可记为 FF00::/8（<span style="color:#DD5746">发送到一组主机，类似于 QQ 群号</span>）     |
| 本地链路单播地址 |   1111111010（10 位），可记为 FE80::/10（<span style="color:#DD5746">局域网内通信，不会被路由器转发</span>）   |
|   全球单播地址   |                                        除上述四种外的其他所有 IPv6 地址                                        |

IPv6 数据报的<span style="color:#5E1675">目的地址</span>有以下三种基本类型：

1. **单播（unicast）**：就是传统的点对点通信。
2. <span style="color:#5272F2; font-weight:bold">多播（multicast）</span>：一点对多点的通信，数据报<span style="color:#5272F2">发送到一组计算机中的每一台</span>。（应用：网络会议）
3. <span style="color:#FDAF75; font-weight:bold">任播（anycast）</span>：这是 IPv6 增加的一种类型。任播的终点是一组计算机，但数据报只交付其中的一台计算机，<span style="color:#FDAF75">通常是距离最近的一台计算机</span>。（应用：多个 DNS 服务器共享一个任播地址）

> [!tip]
>
> <span style="color:#FDAF75">任播</span>地址没有固定的前缀，通常由地址管理机构预先统一分配。

---

<img src="../images/image-202601030230.webp" style="zoom:50%;" />

---

**知识总览**：

<img src="../images/image-202501030232.webp" style="zoom:50%;" />

## 路由算法

**知识总览**：

<img src="../images/image-202601031358.webp" style="zoom:50%;" />

### 路由算法与路由协议之间的关系

<img src="../images/image-202601031400.webp" style="zoom:50%;" />

> [!tip]
>
> **术语别名**：
>
> - 路由协议 = 路由选择协议
> - 路由算法 = 路由选择算法

### 路由算法的本质是“图的最短路径”问题

<img src="../images/image-202601031403.webp" style="zoom:50%;" />

路由协议会制定一种规则，度量一条边的“权值（代价）”。

当一台路由器转发 IP 数据报时，本质就是要找到从本路由器到达目的网络的“最佳路径”。

### 路由算法的分类

根据<span style="color:#FF4B91">能否随网络的通信量或拓扑自适应地进行调整变化</span>来划分，路由算法可划分为两大类：

1. <span style="color:#ED7B7B; font-weight:bold">静态路由算法</span>：指由<span style="color:#FF4B91">网络管理员手工配置</span>每一条路由。（<span style="color:#FF6D28">实现简单、开销小，不具备自适应能力；适用于小型网络</span>）
2. <span style="color:#836096; font-weight:bold">动态路由算法</span>：<span style="color:#FF4B91">路由器</span>根据网络流量负载和拓扑结构的变化来<span style="color:#FF4B91">动态调整</span>自身的路由表。（<span style="color:#53BF9D">实现复杂、开销大、具备自适应能力；适用于大型网络</span>）

### 距离-向量路由算法

<img src="../images/image-202601031418.webp" style="zoom:50%;" />

**Bellman-Ford 算法的核心思想**：假设 $d_x(net1)$ 表示从节点 $x$ 到节点 $net1$ 的最短距离（最小代价），则有 $d_x(net1) = \min\{c(x, v) + d_v(net1)\}$。（其中，$v$ 是 $x$ 的所以邻居）

> [!tip]
>
> 不同的路由协议对“距离”的定义可能不同。例如可以规定：
>
> - 直接相连的两个节点之间，距离为 1
> - 以往返时延作为链路的“距离”

<img src="../images/image-202601031508.webp" style="zoom:50%;" />

---

<img src="../images/image-202601031517.webp" style="zoom:50%;" />

<img src="../images/image-202601031520.webp" style="zoom:50%;" />

### 链路状态路由算法

<span style="color:#EC9B3B"><u>链路状态路由算法</u></span>要求每台路由器节点都了解完整的网络拓扑结构。（知道全网有多少个节点、哪些节点是相连的、其代价是多少等）

只要一台路由器知道完整的网络拓扑结构（数据结构：带权图），就可以用“<span style="color:#187498">迪杰斯特拉 Dijkstra 算法</span>”找打最优转发路径。

<img src="../images/image-202601031552.webp" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202601031609.webp" style="zoom:50%;" />

## 分层次的路由协议

### 思考：RIP、OSPF 能否用于全世界的路由器？

<img src="../images/image-202601031617.png" style="zoom:50%;" />

**RIP 路由协议**：基于<span style="color:#4D96FF">距离向量路由算法</span>。路由器要把自身的“距离向量”告诉邻居们。<span style="color:#8843F2">网络数量越多，距离向量越大。</span>

**OSPF 路由协议**：基于<span style="color:#4D96FF">链路状态路由算法</span>，<span style="color:#8843F2">要求每一台路由器都要建立整个网络的拓扑图</span>。

<span style="color:#FF9234; font-weight:bold">全世界的路由器数量、网络数量数以亿计，不可能让每台路由器都知晓全世界的网络状况。</span>

### 分层次路由协议

将全世界的网络划分为多个相互独立的<span style="color:#005F99"><u>自治系统</u></span>。例如，由哈基米电信管辖的网络区域可申请成为<span style="color:#005F99"><u>自治系统 AS</u></span>（Autonomous System）。

<img src="../images/image-202601031638.webp" style="zoom:50%;" />

AS 的管理单位有权决定在本自治系统内，使用何种<span style="color:#184D47; font-weight:bold"><u>内部路由协议</u>（如 RIP、OSPF）</span>。

每个 AS 至少要有一台<span style="color:#693C72"><u>自治系统边界路由器</u></span>（如 R6）与其他自治系统相连。

<span style="color:#FF75A0">各边界路由器之间</span>，使用统一的<span style="color:#59886B; font-weight:bold"><u>外部路由协议（如 BGP-4）</u></span>。

<span style="color:#C56183">自治系统之间</span>的路由选择也称<span style="color:#C56183; font-weight:bold">域间路由选择</span>，<span style="color:#F2A51A">自治系统内部</span>的路由选择你也称<span style="color:#F2A51A; font-weight:bold">域间路由选择</span>。

---

全世界的路由器数量、网络数量过多，不可能让每台路由器都知晓全世界的网络状况。因此有必要采取**分层次的路由协议**。

互联网将**路由协议**划分为两大类：

1. <span style="color:#7189BF">内部网关协议</span>（Interior Gateway Protocol, <span style="color:#FF5959">IGP</span>）用于 AS 内部的路由选择。例如 <span style="color:#7189BF">RIP</span>、<span style="color:#7189BF">OSPF</span>。
2. <span style="color:#00A8B5">外部网关协议</span>（External Gateway Protocol, <span style="color:#FF5959">EGP</span>）用于 AS 之间的路由选择。例如 <span style="color:#00A8B5">BGP</span>。

> [!tip]
>
> - 网关 = 路由器（早期术语沿用至今）
> - 内部网关协议 = 各地方言
> - 外部网关协议 = 普通话

### 关于自治系统的一些拓展

- 全世界目前已经接近 8w 个<span style="color:#005F99"><u>自治系统</u></span>
- 每个自治系统拥有全球唯一的 <span style="color:#8D448B">AS 编号</span>（Autonomous System Number, <span style="color:#8D448B; font-weight:bold">ASN</span>），需要向互联网管理机构申请
- <span style="color:#EB5F5D; font-weight:bold">自治系统之间是平级关系，不存在包含关系</span>
- 一个自治系统通常包含一个或多个 CIDR 地址块（便于路由聚合）

---

**知识回顾**：

<img src="../images/image-202601031750.webp" style="zoom:50%;" />

## RIP

路由信息协议（<span style="color:#FF5959">R</span>outing <span style="color:#FF5959">I</span>nformation <span style="color:#FF5959">P</span>rotocol, RIP）。

**知识总览**：

<img src="../images/image-202601031754.webp" style="zoom:50%;" />

### RIP 协议在协议栈中的位置

<span style="color:#D65D7A">RIP 属于应用层，它使用 UDP 传送数据（端口 = 520）。</span>

<img src="../images/image-202601031756.webp" style="zoom:50%;" />

RIP 协议定义了两种报文：

- **Request 报文**：请求邻居路由器发送其路由表，用于启动或查询。
- **Response 报文**：响应请求或定期发送给邻居路由器，<span style="color:#C84361">携带完整</span>或<span style="color:#11CBD7"><u>部分</u></span><span style="color:#C84361">路由表</span>。

**解释**：由于每个 Response 报文最多携带 25 个路由表项信息，因此如果路由表太大，就需要拆分为多个 Response 报文，每个报文携带<u>部分</u>路由表。

### RIP 的规定

**RIP 如何定义路径长度？**

1. RIP 使用<span style="color:#7692E4; font-weight:bold">跳数</span>（Hop Count，或称<span style="color:#7692E4; font-weight:bold">距离</span>）来衡量到达目的网络的距离。<span style="color:#E67676">规定：路由器到直连网络的距离为 1；而每经过一个路由器，距离就加 1。</span>
2. RIP 认为<span style="color:#E67676">好的路由</span>就是<span style="color:#7692E4; font-weight:bold">跳数最少的</span>。
3. RIP 允许<span style="color:#E67676">一条合法路径距离不可超过 15</span>。<span style="color:#F3558E; font-weight:bold">距离等于 16 表示网络不可达。</span>可见<span style="color:#F3558E; font-weight:bold"> RIP 只适用于小型自治系统</span>。

<img src="../images/image-202601031816.webp" style="zoom:50%;" />

**RIP 如何定义路由表格式？**

1. 每个路由器都要维护自己的<span style="color:#1FB57B; font-weight:bold">路由表</span>，路由表项有三个关键字段：`<目的网络 N, 距离 d, 下一跳路由器地址 X>`。
2. 每个路由器都要维护从它自身到其他每个目的网络的距离记录，即<span style="color:#1FB57B; font-weight:bold">距离向量</span>。（事实上，<span style="color:#1FB57B; font-weight:bold">距离向量</span>信息包含在<span style="color:#1FB57B; font-weight:bold">路由表</span>中，RIP 协议使用“距离向量路由算法”计算最短路径）

**某路由器的路由表示例**：

| 目的网络 | 距离 | 下一跳路由器 |
| :------: | :--: | :----------: |
|   Net1   |  1   |   直接交付   |
|   Net2   |  16  |     NULL     |
|   Net3   |  2   |      R6      |
|   Net4   |  2   |      R9      |

路由表是通过 RIP 逐步生成的。

### 运行 RIP 的路由器之间如何交换必要信息？

1. Who，和谁交换信息：仅和<span style="color:#FAB57A; font-weight:bold">直接相邻的路由器</span>交换信息。
2. What，交换什么信息：交换的信息是本路由器所知道的全部信息，即<span style="color:#5A7863; font-weight:bold">自己的路由表</span>（其实就是距离向量）。
3. When，何时交换信息：<span style="color:#E67676">通常按固定的时间间隔（通常为 30 秒）交换路由信息。</span>

> [!tip]
>
> 为了加快 RIP 收敛速度，也可以引入<span style="color:#00B7B5">触发更新（Triggered Update）机制</span>——当路由器发现网络拓扑发生变化时，<u>立即</u>向相邻路由器通告拓扑变化后的路由信息，而不必等待 30 秒。

<img src="../images/image-202601031840.webp" style="zoom:50%;" />

## RIP 的工作过程示例（从路由器启动到收敛）

### RIP 的工作过程（基于距离向量算法）

路由器<span style="color:#CF0F0F">刚开始工作时，只晓得自己到直接相连的几个网络的距离为 1</span>。每个路由器<span style="color:#F79A19; font-weight:bold">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。经过若干次交换和更新后，所有的路由器最终都会知道到达本自治系统内任何网络的最短距离和下一跳路由器的地址，称为<span style="color:#F96E5B; font-weight:bold">收敛</span>。

对每个相邻路由器发送来的 RIP 报文，执行如下步骤：

1. 对地址为 X 的相邻路由器发来的 RIP 报文，先修改该报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有“距离”字段的值加 1。（<span style="color:#F96E5B">本质是距离向量路由算法</span>）

2. 对修改后的 RIP 报文中的每个项目，执行如下步骤：

   <img src="../images/image-202601032135.svg" style="zoom: 67%;" />

   > [!tip]
   >
   > 1. 有没有发现新网络？
   > 2. 旧网络的距离是否要更新？
   >    - 找到一条新路径，距离更近
   >    - 继续走老路，但老路距离有变化

3. <span style="color:#36656B">若 180 秒（RIP 默认超时时间）还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达的路由器，即把距离设置为 16（表示不可达）。</span>

4. 返回。

### 例：哈基米电信构建的自治系统

<img src="../images/image-202601032147.webp" style="zoom:50%;" />

### 初始：各路由器同时开机，构建初始路由表

<img src="../images/image-202601032241.webp" style="zoom:50%;" />

路由器<span style="color:#6E026F">刚开始工作时，只知道自己到直接相连的几个网络的距离为 1</span>。

### 0 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601032247.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601032243.webp" style="zoom:50%;" />

<img src="../images/image-202601032259.webp" style="zoom:50%;" />

**检查**：

1. 有没有发现新网络？
2. 旧网络的距离是否要更新？

### 30 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601032308.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601032311.webp" style="zoom:50%;" />

<img src="../images/image-202601032311.webp" style="zoom:50%;" />

**检查**：

1. 有没有发现新网络？
2. 旧网络的距离是否要更新？

<img src="../images/image-202601032352.webp" style="zoom:50%;" />

### 60 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601032356.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601040000.webp" style="zoom:50%;" />

**检查**：

1. 有没有发现新网络？
2. 旧网络的距离是否要更新？

<img src="../images/image-202601040001.webp" style="zoom:50%;" />

<span style="color:#8F384D; font-weight:bold">经过本轮更新，RIP 已<u>收敛</u>。</span>

### 90 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601040009.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601040010.webp" style="zoom:50%;" />

<span style="color:#E9290F">本轮没有任何路由器需要更新路由表（<span style="font-weight:bold">因为 RIP 已收敛</span>）。</span>

## RIP 的工作过程示例（动态适应网络拓扑变化）

### 100 时刻：假设 R1、R4 之间新增一条链路

<img src="../images/image-202601040018.webp" style="zoom:50%;" />

> [!tip]
>
> 为了加快 RIP 收敛速度，也可以引入<span style="color:#00B7B5">触发更新（Triggered Update）机制</span>——当路由器发现网络拓扑发生变化时，<u>立即</u>向相邻路由器通告拓扑变化后的路由信息，而不必等待 30 秒。
>
> <span style="color:#A55540; font-weight:bold">本例中，假设不引入触发更新机制。</span>

### 120 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601040018.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601040019.webp" style="zoom:50%;" />

<img src="../images/image-202601040020.webp" style="zoom:50%;" />

### 150 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601040039.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601040043.webp" style="zoom:50%;" />

**检查**：

1. 有没有发现新网络？
2. 旧网络的距离是否要更新？

<img src="../images/image-202601040044.webp" style="zoom:50%;" />

<span style="color:#8F384D; font-weight:bold">经过本轮更新，RIP 再次<u>收敛</u>。</span>

## RIP 的工作过程示例（反映 RIP 的缺点）

### RIP 的优缺点

**RIP 的优点**：

1. 实现简单、开销小、收敛过程较快。
2. 若一个路由器发现了更短的路由，则这种更新信息就传播得很快，在较短时间内便可传至所有路由器，俗称“<span style="color:#BC4873; font-weight:bold">好消息传播更快</span>”。

**RIP 的缺点**：

1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
2. 路由器之间交换的是路由器中的完整路由表，因此网络规模越大，开销也越大。
3. 当网络出现故障时，路由器之间需反复多次交换信息才能完成收敛，需经过较长时间才能将故障消息传送至所有路由器（<span style="color:#090088; font-weight:bold">慢收敛现象</span>），俗称“<span style="color:#090088; font-weight:bold">坏消息传播得慢</span>”。

> [!tip]
>
> 距离向量路由可能会出现环路的情况，RIP 规定路径上的最高跳数为 16 是一种防止环路的简单粗暴的方式。

### 160 时刻： 路由器 R2 被 🐀 咬坏

<img src="../images/image-202601040106.webp" style="zoom:50%;" />

<span style="color:#E4007C">若 180 秒（RIP 默认超时时间）还没有收到相邻路由器的更新路由表，则把此路由器记为不可达的路由器，即把距离设置为 16（表示不可达）。</span>

> [!tip]
>
> R1 最近一次收到 R2 的 RIP 报文，是在 150 时刻。因此应该在 150 + 180 = 330 时刻，判定 R2 不可达。

### 330 时刻：路由器 R1 判定 R2 不可达，并更新自己的路由表

<img src="../images/image-202601040112.webp" style="zoom:50%;" />

<img src="../images/image-202601040115.webp" style="zoom:50%;" />

> [!tip]
>
> - RIP 协议支持<span style="color:#B45253">多条等价路径共存</span>，将它们同时加入路由表，实现<span style="color:#B45253">负载均衡转发</span>（如轮询转发）。
> - 此时，转发至 Net2 的路径<span style="color:#6C4AB6">形成环路</span>，IP 数据报会“兜圈子”，直到 TTL = 0 才会被丢弃。

### 330 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601041102.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601041123.webp" style="zoom:50%;" />

**检查**：

1. 有没有发现新网络？
2. 旧网络的距离是否要更新？

### 360 时刻：各路由器向邻居发送 RIP 报文（包含完整路由表）

<img src="../images/image-202601041126.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

### 360 时刻：收到邻居的 RIP 报文后，更新自己的路由信息

<img src="../images/image-202601041129.webp" style="zoom:50%;" />

**检查**：

1. 有没有发现新网络？
2. 旧网络的距离是否要更新？

<img src="../images/image-202601041133.webp" style="zoom:50%;" />

**现象**：每经过一轮路由信息交换，到达 Net2 的距离加 1，多轮迭代后 Net2 的距离增加到 16，才能确定 Net2 不可达。

<span style="color:#F03861; font-weight:bold">RIP 的缺点</span>：坏消息传播得慢（慢收敛现象）。

### 690 时刻：路由表收敛

<img src="../images/image-202601041142.webp" style="zoom:50%;" />

## RIP 的工作过程示例（反映 RIP 的优点）

### 700 时刻：路由器 R2 修复

<img src="../images/image-202601041148.webp" style="zoom:50%;" />

- 路由器<span style="color:#B73535">刚开始工作时，只知道自己到直接相连的几个网络的距离为 1</span>。
- 新路由器构建好初始路由表，就可以<u>立即发送给邻居</u>。
- 新路由器，可以用 <u>RIP 请求报文</u>，迅速向邻居请求路由信息。

<img src="../images/image-202601041154.webp" style="zoom:50%;" />

### 700 时刻：R1、R2 更新路由表

<img src="../images/image-202601041156.webp" style="zoom:50%;" />

### 720 时刻：R1、R3、R4 定时发送 RIP 报文

<img src="../images/image-202601041159.webp" style="zoom:50%;" />

每个路由器<span style="color:#E59934">仅和相邻路由器<u>周期性</u>（周期为 30 秒）地交换并更新路由信息</span>。

<img src="../images/image-202601041205.webp" style="zoom:50%;" />

**检查**：

1. 有没有发现新网络？
2. 旧网络的距离是否要更新？

所有路由器迅速收敛！

<span style="color:#965F8A; font-weight:bold">RIP 的优点</span>：好消息传播得快。

## OSPF

开放最短路径优先协议（<span style="color:#FA5C5C">O</span>pen <span style="color:#FA5C5C">S</span>hortest <span style="color:#FA5C5C">P</span>ath <span style="color:#FA5C5C">F</span>irst, OSPF）。

## OSPF 的特点

### OSPF 在协议栈中所处的位置

<img src="../images/image-202601041724.png" style="zoom:50%;" />

- <span style="color:#D25353">OSPF 属于网络层。</span>
- OSPF <span style="color:#3F9AAE"><u>使用 IP 协议提供的服务</u></span>，IP 首部的<span style="color:#3F9AAE">协议字段为 89</span>。
- OSPF 的 PDU 常译为“<span style="color:#DE802B; font-weight:bold">OSPF 分组</span>”或“OSPF 数据报”。
- OSPF 协议定义了<span style="color:#0D4715"> 5 中 OSPF 分组类型</span>。

| Type 值 |             英文全称              |   英文缩写   |     中文译名     |
| :-----: | :-------------------------------: | :----------: | :--------------: |
|    1    |           Hello Packet            | Hello Packet |     问候分组     |
|    2    |    Database Description Packet    |  DD Packet   |  数据库描述分组  |
|    3    |     Link State Request Packet     |  LSR Packet  | 链路状态请求分组 |
|    4    |     Link State Update Packet      |  LSU Packet  | 链路状态更新分组 |
|    5    | Link State Acknowledgement Packet | LSAck Packet | 链路状态确认分组 |

> [!tip]
>
> 在 OSPF 首部中指明 Type 值。

### OSPF 的大致原理

<img src="../images/image-202601041734.png" style="zoom:50%;" />

**OSPF 路由协议**：基于链路状态路由算法（迪杰斯特拉算法）计算最佳转发路径。因此，首先得<span style="color:#FA6868">让每一台路由器都建立整个网络的拓扑图</span>（<span style="color:#5A9CB5">数据结构的<u>带权有向图</u>，可用<u>邻接表</u>存储</span>）。

路由器<span style="color:#CC561E">可以直接探测到的信息</span>：自己和哪些节点直连？

<img src="../images/image-202601041751.png" style="zoom:50%;" />

### OSPF 的主要特点

怎样将自己探测到的信息“说给”其他所有路由器？

- What，说什么？与自己<u>直连的所有</u><span style="color:#FD7979">链路状态</span>（<span style="color:#FD7979; font-weight:bold">LS</span>, Link-State）。
  - 我是谁？（数据结构：图的节点）
  - 我的邻居都有谁？（数据结构：图的节点）
  - 我到每个邻居之间的代价是多少？（带权有向边）

- How，怎么说？<span style="color:#8F0177">洪泛法（Flooding）。</span>
  - 一传十，十传百，迅速广而告之。
  - 洪泛信息不可“回流”转发。
  - 若收到重复的链路专题信息，不可重复转发。
- When，什么时候说？<span style="color:#3DB6B1">探测到生变有变化时。</span>
  - 路由器探测到与自己直连的链路或节点<span style="color:#3DB6B1">发生变化</span>时，就<span style="color:#3DB6B1">立即洪泛</span>最新的链路状态信息。
  - 不存在“坏消息传播得慢”的问题。

### OSPF 的其他特点

<img src="../images/image-202601041734.png" style="zoom:50%;" />

1. OSPF 允许对每条路由设置成不同的代价，对于不同类型的业务可计算出不同的路由。

   例如，OSPF <u>默认</u>基于带宽计算链路代价：<span style="color:#016B61">metric = 参考带宽 / 接口带宽</span>。

   > [!tip]
   >
   > 参考带宽默认为 100Mbps。

   为了简化图示，<span style="color:#CD2C58">默认两台路由器之间的链路两个方向权值相同</span>，但<u>在现实应用中</u>：

   - <span style="color:#16476A; font-weight:bold">一段链路的两个方向，权值可能不同。</span>
   - <span style="color:#4C763B; font-weight:bold">「直连网络 → 路由器」方向的权值通常为 0。</span>（例如 R1 到 Net2 的总代价为 3 + 1 = 4，而 Net1 到 Net2 的总代价为 <span style="color:#0046FF; font-weight:bold">0</span> + 3 + 1 = 4）

2. 若到同一个目的网络有多条相同代价的路径，则可将通信量分配给这几条路径。

   例如：R3 到 Net6 的最短路径有两条（总代价相等），两条路径都会用于转发（可使负载均衡）。

   <img src="../images/image-202601041839.png" style="zoom:50%;" />

3. OSPF 分组具有<span style="color:#FA812F; font-weight:bold">鉴别功能</span>，从而保证仅在<span style="color:#636CCB">可信赖的路由器</span>之间交换链路状态信息。例如：

   - **防止非法路由器的恶意攻击**：恶意黑客非法侵入哈基米电信机房，将未授权路由器接入 R1 设备，通过 OSPF 协议洪泛伪造 LSA。

     <img src="../images/image-202601041846.webp" style="zoom:50%;" />

     <img src="../images/image-202601041848.bmp" style="zoom:50%;" />

   - **防止中间人攻击篡改 OSPF 洪泛分组**：某台路由器（如 R3）被黑客攻击（中病毒），当 R3 作为中间人转发洪泛的链路信息时，恶意地将路由信息改为错误信息。

4. OSPF 支持可变长度的子网划分和无分类编制 CIDR。

   <img src="../images/image-202601041855.webp" style="zoom:50%;" />

5. 每个链路状态都带上一个 32 位的序号，<span style="color:#ED3F27">序号越大，状态就越新</span>。（相当于信息的版本号）

   <img src="../images/image-202601041734.png" style="zoom:50%;" />

   <img src="../images/image-202601041901.jpg" style="zoom:50%;" />

   <img src="../images/image-202601041902.jpg" style="zoom:50%;" />

   <img src="../images/image-202601042011.jpg" style="zoom:50%;" />

   其他路由器收到 R5 洪泛的链路状态信息后，根据序号值判断应该以哪个版本为准。

---

**知识回顾**：

<img src="../images/image-202601042014.jpg" style="zoom:50%;" />

## OSPF 基本工作原理

### 路由器构建 LSDB，使用 Dijkstra 算法计算最短路径

<img src="../images/image-202601042022.webp" style="zoom:50%;" />

> [!tip]
>
> 使用洪泛机制（Flooding）机制，所有路由器可以迅速构建统一的 <span style="color:#E45A92; font-weight:bold">LSDB</span>。

例如路由器 R1 运行迪杰斯特拉算法后可知：

- 到 Net0 的最短路径为 cost = 2，R1 → <span style="color:#DC143C">Net0</span>。
- 到 Net1 的最短路径为 cost = 1，R1 → <span style="color:#DC143C">Net1</span>。
- 到 Net2 的最短路径为 cost = 4，R1 → <span style="color:#DC143C">R2</span> → Net2。
- 到 Net3 的最短路径为 cost = 3，R1 → <span style="color:#DC143C">R3</span> → Net3。
- 到 Net4 的最短路径为 cost = 3，R1 → <span style="color:#DC143C">R3</span> → R4 → Net4。
- 到 Net5 的最短路径为 cost = 5，R1 → <span style="color:#DC143C">R3</span> → R5 → Net5。
- 到 Net6 的最短路径为 cost = 9，R1 → <span style="color:#DC143C">R3</span> → R5 → R6 → Net6 或 R1 → <span style="color:#DC143C">R3</span> → R4 → R6 → Net6。（改进后的 Dijkstra 算法支持找到多条等价最短路径）

**路由器 R1 生成的路由表**：

| 目的网络<br />Destination | 下一跳<br />Next Hop | 距离<br />Distance |
| :-----------------------: | :------------------: | :----------------: |
|           Net1            |       直接交付       |         1          |
|           Net2            |          R2          |         4          |
|           Net3            |          R3          |         3          |
|           Net4            |          R3          |         3          |
|           Net5            |          R3          |         5          |
|           Net6            |          R3          |         9          |
|           Net0            |      外部路由器      |         2          |

> [!tip]
>
> 目的网络由 IP 地址、子网掩码组成，例如 Net1 为 168.168.0.0/26，Net0 为 0.0.0.0/0。

- 虽然使用 Dijkstra 算法可以计算出完整的最优路径，但<span style="color:#0BA6DF">路由表中不会存储完整路径，而只存储“下一跳”</span>。
- <span style="color:#556B2F">若网络拓扑发生变化，就会立即引起<u>洪泛</u>，从而引起各台路由器的 LSDB 变化，并再次运行 Dijkstra 算法，构造新的路由表。</span>

### 思考：超大型自治系统的 LSDB

<img src="../images/image-202601042022.webp" style="zoom:50%;" />

如果自治系统规模很大，路由器、网络很多，岂不是会让 LSDB 很大？（每台路由器都要存储一份 LSDB）

显然，<span style="color:#E62727">自治系统越大，LSDB 越复杂，洪泛压力也越大</span>，Dijkstra 算法的运算开销越高。

### OSPF 的“区域”划分

<img src="../images/image-202601042054.webp" style="zoom:50%;" />

- 为了使 OSPF 能用于规模很大的网络，可将一个自治系统再划分为若干<span style="color:#FF0066">区域（Area）</span>。
- 划分区域后，<span style="color:#468A9A">洪泛法（Flooding）交换链路状态信息的范围局限在各个区域</span>，而非整个 AS；这样可以减少网络通信量，也让每个路由器的 LSDB 更小。

---

1. 一个 OSPF 自治系统内，<span style="color:#E43636">只有一个主干区域</span>（Backbone Area）。
   - 主干区域的作用是连通其他区域。
   - 主干区域的标识符 Area ID = 0。
   - 主干区域内，至少有一台<span style="color:#001BB7; font-weight:bold">自治系统路由器（ASBR）</span>与<span style="color:#001BB7"><u>其他自治系统</u></span>相连。
2. 每一个非主干区域，都至少有一台<span style="color:#689B8A; font-weight:bold">区域边界路由器（ABR）</span>与<span style="color:#689B8A"><u>主干区域</u></span>相连。

> [!tip]
>
> - 非主干区域和主干区域通常直接相连。
> - ***区域内部路由器***仅需知道本区域的网络拓扑。
> - ***区域边界路由器***需要知道直连区域、主干区域的网络拓扑。

### 几类路由器

<img src="../images/image-202601042054.webp" style="zoom:50%;" />

- <span style="color:#239BA7; font-weight:bold">自治系统边界路由器（R6）</span>：负责本自治系统与其他自治系统之间的 IP 分组路由转发。
- <span style="color:#386641; font-weight:bold">区域边界路由器（R3、R4、R7）</span>：负责为流向/流出该区域的 IP 分组提供路由转发。
- <span style="color:#FF9B2F; font-weight:bold">区域内部路由器（R1、R2、R5、R8、R9）</span>：也称<span style="color:#FF9B2F"><u>非边界路由器</u></span>，负责本区域内的 IP 分组路由转发，发往其他区域的 IP 分组会转发给“区域边界路由器”处理。

---

**知识回顾**：

<img src="../images/image-202601042159.webp" style="zoom:50%;" />

### 术语：LSDB、LSA、LSI

<img src="../images/image-202601042339.webp" style="zoom:50%;" />

> [!tip]
>
> **类比**：
>
> - <span style="color:#C75D2C; font-weight:bold">LSDB</span> 是<u>一本书</u>。
> - <span style="color:#3E5F44; font-weight:bold">LSA</span> 是<u>书的一个章节</u>
> - <span style="color:#34699A; font-weight:bold">LSI</span> 泛指<u>书的内容</u>

### 拓展：LSDB 完整结构

<img src="../images/image-202601042345.webp" style="zoom:50%;" />

> [!tip]
>
> 直连网络到路由器的代价通常视为 0。

## OSPF 的分组类型

### OSPF 的分组类型

<img src="../images/image-202601042352.webp" style="zoom:50%;" />

| Type 值 |                    英文缩写                     |                      中文译名                       |                             作用                             |
| :-----: | :---------------------------------------------: | :-------------------------------------------------: | :----------------------------------------------------------: |
|    1    | <span style="color:#EA5B6F">Hello</span> Packet |     <span style="color:#EA5B6F">问候</span>分组     |      建立和维持邻居关系（每隔 10 秒发一次，40 秒超时）       |
|    2    |  <span style="color:#EA5B6F">DD</span> Packet   |  <span style="color:#EA5B6F">数据库描述</span>分组  | 邻居建立时，向邻居给出自己的 <span style="color:#EA5B6F">LSDB 摘要（即 LSA 的头信息）</span> |
|    3    |  <span style="color:#EA5B6F">LSR</span> Packet  | <span style="color:#EA5B6F">链路状态请求</span>分组 |            向邻居请求缺少的 LSA（指明头信息即可）            |
|    4    |  <span style="color:#EA5B6F">LSU</span> Packet  | <span style="color:#EA5B6F">链路状态更新</span>分组 |            向邻居传输具体的 LSA（肯引发全网洪泛）            |
|    5    | <span style="color:#EA5B6F">LSAck</span> Packet | <span style="color:#EA5B6F">链路状态确认</span>分组 |  收到邻居发来的 LSU 后，向邻居确认收到了哪些 LSA（头信息）   |

### 术语：LSDB、LSA、LSA 头信息

<img src="../images/image-202601050014.webp" style="zoom:50%;" />

### Type 1：Hello 分组（问候分组）

<img src="../images/image-202601050020.webp" style="zoom:50%;" />

<img src="../images/image-202601050034.webp" style="zoom:50%;" />

- 各台服务器每隔 10 秒向<u>直接邻居</u>发送一次<span style="color:#9929EA">“问候分组”（Hello 分组）</span>。
- 如果<span style="color:#3D74B6">超过 40 秒</span>未收到邻居的问候，就认为该邻居<span style="color:#3D74B6">不可达</span>。

<img src="../images/image-202601050048.webp" style="zoom:50%;" />

<img src="../images/image-202601050056.webp" style="zoom:50%;" />

假设某时刻 R2 与 R1 建立连接：

- 向新邻居发生 Hello 分组。

- 确认邻居关系。

- <span style="color:#1B3C53">更新链路状态信息。</span>

> [!tip]
>
> 在现实应用中，一旦链路信息发生变化就要立即<span style="color:#F68537; font-weight:bold">洪泛</span>通知全网，为简化理解，此处暂不展开讨论。

### Type 2：DD 分组（数据库描述分组）

<img src="../images/image-202601050057.webp" style="zoom:50%;" />

- 两台路由器的邻居关系建立后，通过数据库描述分组，向邻居给出自己的 <span style="color:#BA487F">LSDB 摘要（即 LSA 的头信息）</span>。
- 如果 LSDB 摘要信息量很大，可以拆分为多个数据库描述分组。

### Type 3：LSR  分组（链路状态请求分组）

<img src="../images/image-202601050058.webp" style="zoom:50%;" />

通过 LSR 分组，向邻居请求缺少的 LSA（头信息）。

### Type 4：LSU 分组（链路状态更新分组）

<img src="../images/image-202601050059.webp" style="zoom:50%;" />

<img src="../images/image-202601050127.webp" style="zoom:50%;" />

路由器通过 LSU 分组，向邻居传输具体的 LSA（可能引发全网洪泛）。

<img src="../images/image-202601050129.webp" style="zoom:50%;" />

> [!tip]
>
> 即便重复收到洪泛的 LSU 分组，也要给邻居返回 <span style="color:#7B4019">LSAck</span>。

### Type 5：LSAck 分组（链路状态确认分组）

<img src="../images/image-202601050128.webp" style="zoom:50%;" />

路由器收到邻居发来的 LSU 后，返回<span style="color:#06923E"> LSAck 分组</span>，向邻居确认收到了哪些 LSA（头信息）。

