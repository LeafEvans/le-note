# 网络层

<img src="../images/image-202512240004.webp" style="zoom:60%;" />

<u>**网络层**</u>为<u>传输层</u>提供服务，将传输层的数据封装成**“IP 数据报”**。网络中的路由器根据 IP 数据报首部中的*<u>源 IP 地址</u>*、<u>*目的 IP 地址*</u>进行“分组转发”。因此，网络层实现了**“主机到主机”**的传输。

<u>数据链路层</u>为<u>网络层</u>提供服务，将网络层的 **IP 数据报（分组）**封装成***<u>帧</u>***，传输给下一个**相邻结点**。

<img src="../images/image-202512240017.webp" style="zoom:50%;" />

IP 地址，用 32bit 表示，有 <u>01101110</u> <u>10111111</u> <u>10110101</u> <u>00110001</u>。

常以 **8bit** 为一族，记为十进制数。（显然每个部分的合法范围为 <u>0~255</u>）

## 网络层的功能

**知识总览**：

<img src="../images/image-202512240026.webp" style="zoom:50%;" />

<img src="../images/image-202512240049.webp" style="zoom:50%;" />

> [!tip]
>
> - 接入网络的每台主机至少拥有一个 IP 地址
> - 通常，路由器的每个接口都需要分配一个 IP 地址（最新技术标准已经取消了这个强制要求）

### IPv4 分组

### 各种协议之间的服务关系

<img src="../images/image-202512240053.webp" style="zoom:50%;" />

**IP 协议**（Internet Protocal，网际协议）是<u>互联网的核心</u>。

**ARP 协议**用于查询同一网络中的 <主机 IP 地址, MAC 地址> 之间的映射关系。

**ICMP 协议**用于网络层实体时间相互通知“异常事件”。

**IGMP 协议**用于实现 IP 组播。

### IP 数据报（IP 分组）的格式

<img src="../images/image-202512240103.webp" style="zoom:50%;" />

<img src="../images/image-202512240137.webp" style="zoom:50%;" />

<img src="../images/image-202512240206.webp" style="zoom:50%;" />

TTL 的初始值通常由**源主机**设置。

每经过一个路由器，路由器就将 TTL 减 1，如果 TTL 减到 0，就直接丢弃分组，并向源主机发送 ICMP 报文。

> [!tip]
>
> ICMP 报文用于通知一个节点发生了某种“异常”。

---

<img src="../images/image-202512240105.webp" style="zoom:50%;" />

### IP 数据报的“分片”问题

<img src="../images/image-202512240111.webp" style="zoom:50%;" />

**重要概念**：一个链路层数据帧能承载的最大数据量称为<u>最大传送单元（MTU）</u>。如以太网的 MTU = 1500B。

若一个 IP 数据报的总长度超出了下一段链路的 MTU，就需要分片。

<img src="../images/image-202512240118.webp" style="zoom:50%;" />

<img src="../images/image-202512240119.webp" style="zoom:50%;" />

> [!tip]
>
> 每个分片都是一个可以被单独转发的 IP 数据报，都包含首部。

- IP 数据报的<span style="color:#EA2264; font-weight:bold">“分片”</span>可能在<span style="color:#EA2264; font-weight:bold">源主机、或任何一个路由器</span>中发生。
- 只有<span style="color:#33A1E0; font-weight:bold">目的主机</span>才会对分片进行<span style="color:#33A1E0; font-weight:bold">“重组”</span>。
- 各分片有可能乱序到达目的主机。
- 由于首部的“片偏移”字段是以 <u>×8B</u> 为单位，因此，**除了<u>最后一个分片</u>外，其他每个分片的数据部分必须是 8B 的整数倍**。

### IP 数据报的生存时间“TTL”（可达示例）

<img src="../images/image-202512240201.webp" style="zoom:50%;" />

### IP 数据报的生存时间“TTL”（不可达示例）

<img src="../images/image-202512240158.webp" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202512240209.jpg" style="zoom:50%;" />

## IP 地址（最初的分类方案）
### IP 数据报（IP 分组）的格式

<img src="../images/image-202512240216.jpg" style="zoom:50%;" />

### 最初的 IP 地址分类方案

<img src="../images/image-202512240217.jpg" style="zoom:50%;" />

**时代背景**：IPv4 协议是 1981 年发明的，当时只有政府、学校、军队等大机构会使用互联网。完全没有预料到互联网用户会迎来爆炸性增长。因此 IPv4 协议中，地址位数仅设计了 32bit（$2^{32} \approx 42$ 亿）。

> [!tip]
>
> IP 地址资源由 ICANN（互联网名字和数字分配机构）进行分配（有偿租用）。

<img src="../images/image-202512240220.jpg" style="zoom:50%;" />

- 在那个年代，要求**每台主机每个路由器接口被分配的 IP 地址都是全球唯一的**。
- **路由器和路由器连接的接口可以不分配 IP 地址**，但**路由器和其他节点连接的接口必须分配 IP 地址**
- 从属于**<u>同一个网络</u>的所有主机、路由器接口的 IP 地址“网络号”都相同**
- 当一台新主机接入网络时，需要给它分配一个IP地址、并配置“默认网关”

<img src="../images/image-202512240709.jpg" style="zoom:50%;" />

### 一些特殊用途的 IP 地址

| 网络号 |          主机号          | 作为分组源地址？ | 作为分组目的地址？ |                      代表的含义                      |
| :----: | :----------------------: | :--------------: | :----------------: | :--------------------------------------------------: |
|   Y    |           全 0           |        ×         |         ×          |      表示整个网络本身（只能用于路由表、转发表）      |
|   Y    |           全 1           |        ×         |         ✓          |           向网络号为 Y 的网络广播 IP 分组            |
|   0    |            Y             |        ✓         |         ×          |            表示本网络中主机号为 Y 的主机             |
|  全 0  |           全 0           |        ✓         |         ×          |       本网络上的本主机（会在 DHCP 协议中使用）       |
|  全 1  |           全 1           |        ×         |         ✓          |                 向本网络广播 IP 分组                 |
|  127   | 非全 0 或非全 1 的任何数 |        ✓         |         ✓          | 环回自检地址。表示一台主机本身，用于本地软件环回测试 |

> [!tip]
>
> <span style="color:#ED3F27">以上这些特殊地址不可指派给网络中的任何一台主机或路由器“私用”。</span>

**重要结论**：前 2 行说明，若一个网络中，<span style="color:#006A67; font-weight:bold">主机号占 N bit</span>，那么在这个网络中，<span style="color:#006A67; font-weight:bold">最多支持 2^N^ - 2 台</span>主机 & 路由器。

## 子网划分 & 子网掩码

**知识总览**：

<img src="../images/image-202512240743.jpg" style="zoom:50%;" />

### 暂未使用子网划分技术

<img src="../images/image-202512240748.jpg" style="zoom: 67%;" />

### 学校网络使用了子网划分技术（划分为两个子网道计算机）

<img src="../images/image-202512240800.jpg" style="zoom: 67%;" />

### 学校网络使用了子网划分技术（划分为 4 个子网）

<img src="../images/image-202512240805.jpg" style="zoom: 67%;" />

<img src="../images/image-202512240907.jpg" style="zoom:50%;" />

<img src="../images/image-202512240909.jpg" style="zoom:50%;" />

### 子网掩码的 CIDR 记法

<img src="../images/image-202512240915.jpg" style="zoom: 67%;" />

## 无分类编制 CIDR

**知识总览**：

<img src="../images/image-202512240921.jpg" style="zoom:50%;" />

**时代背景**：1993 年推出**无分类编址 CIDR**，当时互联网在民用领域大放异彩，由于每台主机都至少要消耗一个全球唯一的 IP 地址。***<u>IP 地址资源告急。</u>***

### 传统的 IP 地址划分方案有什么缺陷？

<img src="../images/image-202512240923.jpg" style="zoom:50%;" />

- 一个 A 类地址块包含 2^24^ = 16,777,216 个 IP 地址
- 一个 B 类地址块包含 2^16^ = 65536 个 IP 地址
- 一个 C 类地址块包含 2^8^ = 256 个 IP 地址

例如某单位有 2000 台主机想要联网，就不得不申请一个 B 类地址块。

<span style="color:#6F00FF; font-weight:bold">IP 地址资源分配不灵活，利用率低，有限的 IP 地址资源将很快耗尽。</span>

### 无分类编制 CIDR

<img src="../images/image-202512240929.jpg" style="zoom:50%;" />
