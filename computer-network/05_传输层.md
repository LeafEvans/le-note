# 传输层

## 传输层提供的服务

**知识总览**：

<img src="../images/image-202601071855.webp" style="zoom:50%;" />

### 传输层在协议栈中的位置

<img src="../images/image-202601071858.webp" style="zoom:50%;" />

### 传输层“端口号”的概念

<img src="../images/image-202601071904.webp" style="zoom:50%;" />

<span style="color:#FF9A00; font-weight:bold">IP 地址 + 端口号 → 指向网络中一台主机上的一个特定的进程</span>

<span style="color:#5D688A">网络层</span>实现了“<u>主机到主机</u>”的通信。网络层在 IP 数据报的首部，指明<span style="color:#5D688A">源 IP 地址、目的 IP 地址</span>。

<span style="color:#C71E64">传输层</span>实现了“<u>端到端</u>”（<u>进程到进程</u>）的通信。传输层在 TCP（或 UDP）报文段的首部，指明<span style="color:#C71E64">源端口、目的端口</span>。

### 进程、端口号、传输层协议之间的关系

<span style="color:#B9375D"><span style="font-weight:bold">假设</span>：进程 1、5 正在用 TCP 通信；2、6 正在用 TCP 通信；3、7 正在用 UDP 通信；4、8 正在用 UDP 通信。</span>

<img src="../images/image-202601071949.webp" style="zoom:50%;" />

**注意**：

- <span style="color:#932F67">两台主机的端口号是相互独立的。</span>
- <span style="color:#34699A; font-weight:bold">TCP、UDP 的端口号也是相互独立的。</span>
- 当两个进程之间想要通信时，需要指明：
  1. 使用哪种传输层协议。
  2. 本进程绑定的端口号。
  3. 对方的 IP 地址和端口号。

<span style="color:#FF894F">套接字（Socket）= `(IP 地址 : 端口号)`。</span>（分为 TCP 套接字、UDP 套接字）

### 熟知端口号

|    应用程序    | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP |
| :------------: | :--: | :----: | :--: | :--: | :--: | :--: | :--: |
| **熟知端口号** |  21  |   23   |  25  |  53  |  69  |  80  | 161  |

0~1023 为熟知端口号，开发的时候一般不使用。

其他端口号在实际开发时并没有特别严格的限制，只要在本机没有被使用的端口号都可以使用。

<span style="color:#FF2DD1">端口号分类只是一种“建议标准”，而非“强制标准”。</span>

### 有连接的传输 vs. 无连接的传输

<img src="../images/image-202601072102.webp" style="zoom:50%;" />

- <span style="color:#ED3500; font-weight:bold">有连接</span>：传输前先打招呼，先<span style="color:#568F87">确认对方已经准备好接收数据</span>。传输结束时，也要<span style="color:#568F87">告知对方已结束</span>。
- <span style="color:#001BB7; font-weight:bold">无连接</span>：不打招呼，直接把数据传给对方。

### 可靠的传输 vs. 不可靠的传输

<img src="../images/image-202601072108.webp" style="zoom:50%;" />

- <span style="color:#B33791; font-weight:bold">可靠的</span>：接收方使用“确认机制”让发送方知道哪些数据已被正确接收。
- <span style="color:#FF9898; font-weight:bold">不可靠的</span>：接收方无论收没收到数据、数据是否正确，都不给发送方反馈。

## UDP 数据报

### UPD 协议、UDP 数据报、UDP 首部

<img src="../images/image-202601082202.webp" style="zoom:50%;" />

- UDP 首部很小，只占 8B。
- UDP 每次传输一个完整的报文，不支持报文自动拆分、重装。
- UDP 是无连接的、不可靠的（可靠性可交给应用层处理），也不支持拥塞控制。
- UDP 支持一对一（封装成单播 IP 数据报）、一对多传输（封装成广播/多播 IP 数据报）。

### TCP 协议、TCP 报文段、TCP 首部

<img src="../images/image-202601082208.webp" style="zoom:50%;" />

- TCP 首部更大，占 20~60B。
- TCP 支持报文自动拆分、重装，因此可以传输长报文。
- TCP 是有连接的、可靠的、支持拥塞控制。
- TCP 仅支持一对一传输（因为通信双方的传输层必须先建立连接）。

### UDP 数据报格式

<img src="../images/image-202601082239.webp" style="zoom:50%;" />

> [!tip]
>
> IP 数据报首部固定占用 20 字节，其数据部分最大长度为 **65535 - 20 = 65515 字节**，因此封转在 IP 数据报数据段内的 UDP 数据报，实际最大长度即为 65515 字节。

### UDP 数据报示例

<img src="../images/image-202601082257.webp" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202601082304.webp" style="zoom:50%;" />

## UDP 检验

### 一种新的差错检验方法

<img src="../images/image-202601082307.webp" style="zoom:50%;" />

<img src="../images/image-202601082312.webp" style="zoom:50%;" />

### UDP 检验（发送方的传输层）

<img src="../images/image-202601082324.webp" style="zoom:50%;" />

1. 传输层的 UDP 协议在计算检验和之前，先添加伪首部。
2. 把伪首部、首部、数据部分以 16bit 为一组，进行二进制加法（最高位产生的仅为需要<u>回卷</u>）。
3. 将最终的加法结果逐位取反，就得到 16bit 检验和，将其填入 UDP 首部。
4. 去掉伪首部，并将 UDP 数据报交给网络层，封装成 IP 数据报。

### UDP 检验（接收方的传输层）

<img src="../images/image-202601090009.webp" style="zoom:50%;" />

1. 网络层向传输层递交 UDP 数据报。
2. 传输层在 UDP 数据报前，添加伪首部。
3. 把伪首部、UDP 首部、数据部分以 16bit 为一组，进行二进制加法（最高位产生的进位需要<u>回卷</u>）。
4. 若加法结果为全 1，说明无比特错误，于是接收该 UDP 数据报，并根据目的端口号，向应用层递交报文；若加法结果不为全 1，说明有差错，于是丢弃该 UDP 数据报。

---

<img src="../images/image-202601090016.webp" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202601090020.webp" style="zoom:50%;" />

### IP 数据报（IP 分组）的格式

<img src="../images/image-202512240103.webp" style="zoom:50%;" />

IP 数据报在传输过程中仅校验首部完整性（不校验数据部分），其校验逻辑与 UDP 检验和一致：

将 IP 数据报首部按 16 位分组，执行二进制求和（需处理进位回卷，即溢出位循环加到和的最低位），对求和结果逐位取反后，即 IP 数据报的首部检验和。需注意的是，该过程**不涉及伪首部**，仅针对 IP 首部本身进行校验。

## TCP 报文段（TCP 段）

TCP Segment（TCP 报文段，另译“TCP 段”）。

<img src="../images/image-202601090050.webp" style="zoom:50%;" />

<img src="../images/image-202601090132.svg" style="zoom:67%;" />

TCP 协议的三大阶段：

- 建立连接（三次握手）
- 数据传输
- 释放连接（四次挥手）
