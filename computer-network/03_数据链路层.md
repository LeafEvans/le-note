# 数据链路层

## 数据链路层的功能

### 数据链路层所处的地位

<img src="../images/image-202511031035.png" style="zoom:80%;" />

<u>数据链路层</u>使用<u>物理层</u>提供的“<span style="color:#4A70A9; font-weight:bold">比特传输</span>”服务。

<u>数据链路层</u>为<u>网络层</u>提供服务，将网络层的 <span style="color:#A72703; font-weight:bold">IP 数据报（分组）</span>封装成**帧**，传输给下一个相邻节点。

**物理链路**：传输介质（0 层）+ 物理层（1 层）实现了相邻节点间的“<span style="color:#F87B1B">物理链路</span>”。

**逻辑链路**：数据链路层需要基于“物理链路”，实现相邻节点间逻辑上无差错的“<span style="color:#F87B1B">数据链路（逻辑链路）</span>”。

---

<img src="../images/image-202511031037.webp" style="zoom:80%;" />

## 组帧

**知识总览**：

<img src="../images/image-202511051147.webp" style="zoom: 50%;" />

> [!tip]
>
> - **帧定界**：Frame Delimiting
> - **透明传输**：Transparent Transmission

### 字符计数法

字符计数法，Character Count Method。

<img src="../images/image-202511051220.webp" style="zoom: 50%;" />

- **原理**：在每个帧的开头，用一个<span style="color:#0046FF">定长计数字段</span>表示帧长。
- **最大缺点**：任何一个计数字段出错，都会导致后续<u>_所有帧_</u>无法定界。

### 字节填充法

字节填充法，Byte Stuffing。

<img src="../images/image-202511051314.webp" style="zoom: 50%;" />

> [!tip]
>
> - SOH: Start of Header
> - EOT: End of Transmission

为避免将数据中的字符误识别为控制字符，引入了转义字符机制：

<img src="../images/image-202511051318.webp" style="zoom:80%;" />

若数据部分中也包含转义字符，可在其前再添加一个转义字符以进行转义：

<img src="../images/image-202511051331.webp" style="zoom:80%;" />

如果帧的数据部分包含“特殊字符”，则<span style="color:#63A361; font-weight:bold">发送方</span>需要<span style="color:#63A361; font-weight:bold">在这些“特殊字符”前填充“转义字符 ESC”</span>（<span style="color:#63A361; font-weight:bold">接收方</span>要做<span style="color:#63A361; font-weight:bold">逆处理</span>）。

### 零比特填充法

零比特填充法，Bit Stuffing。

<img src="../images/image-202511071624.webp" style="zoom:80%;" />

- **发送方**需要对帧的数据部分进行处理，<span style="color:#DC0E0E">每当遇到连续 5 个 1，就填充一个 0</span>。
- **接收方**需要对帧的数据部分进行逆处理，<span style="color:#DC0E0E">每当遇到连续 5 个 1，就删掉后面的 0</span>。

> [!tip]
>
> 数据链路层的 HDLC、PPP 协议均使用零比特填充法进行组帧。

### 违规编码法

违规编码法，Violation Coding。

<img src="../images/image-202511071709.svg" style="zoom:80%;" />

---

**知识回顾**：

<img src="../images/image-202511071726.webp" style="zoom:80%;" />

## 差错控制

**知识总览**：

<img src="../images/image-202511092356.png" style="zoom: 50%;" />

### 奇偶校验码

**知识总览**：

<img src="../images/image-202511092359.png" style="zoom:50%;" />

奇偶校验码，Parity Check Code。

- **奇校验码**：整个校验码（有效信息位和校验位）中“1”的个数为奇数。
- **偶校验码**：这个校验码（有效信息位和校验位）中“1”的个数为偶数。

<img src="../images/image-202511100002.png" style="zoom:50%;" />

举例，给出两个编码 1001101 和 1010111 的奇校验码和偶校验码。

设最高位为校验位，余 7 位是信息位，则对应的奇偶校验码为：

- **奇校验**：<u>1</u>1001101；<u>0</u>1010111。
- **偶校验**：<u>0</u>1001101；<u>1</u>1010111。

偶校验的硬件实现：各信息位经异或（即模 2 加）运算后，所得结果即为偶校验位。

> [!tip]
>
> 模 2 加本质上就是不进位的二进制加法。

$\oplus $：异或（模 2 加）。

- $0 \oplus 0 = 0$

- $0 \oplus 1 = 1$

- $1 \oplus 0 = 1$

- $1 \oplus 1 = 0$

两比特相“异”时，结果为 1。

求偶校验位可以：

$$
1 \oplus 0 \oplus 0 \oplus 1 \oplus 1 \oplus 0 \oplus 1 = 1 \\
1 \oplus 0 \oplus 1 \oplus 0 \oplus 1 \oplus 1 \oplus 1 = 1
$$

进行偶校验（所有位进行异或，若结果为 1 说明出错）：

$$
0 \oplus 1 \oplus 0 \oplus 0 \oplus 1 \oplus 1 \oplus 0 \oplus 1 = 0\\
1 \oplus 1 \oplus 0 \oplus 1 \oplus 0 \oplus 1 \oplus 1 \oplus \underline{0} = 1\\
1 \oplus 1 \oplus 0 \oplus 1 \oplus 0 \oplus 1 \oplus \underline{0} \oplus \underline{0} = 1
$$

可以发现第二个最后一位发生了跳变，结果为 1，说明出错；但是最后一个有两个比特发生了跳变，结果却仍未 0。

因此，数据的接收方无法检测出<u>_偶数位错误_</u>。

> [!tip]
>
> 偶校验比奇校验更为常用，且在硬件上仅需异或门即可生成并验证偶校验位。

---

**知识回顾**：

<img src="../images/image-202511100029.png" style="zoom:80%;" />

### 循环冗余校验

**知识总览**：

<img src="../images/image-202511100857.png" style="zoom: 50%;" />

循环冗余校验（Cyclic Redundancy Check, <span style="color:#DC0E0E">CRC</span>）。

#### 基本思想

约定一个除数，接收方用检测数据除以该除数，检查余数是否发生了改变从而判断数据传输过程中是否出现了错误。

<img src="../images/image-202511100900.png" style="zoom:67%;" />

循环冗余检验码的思想：数据发送方、接收方约定一个“<span style="color:#0046FF">除数</span>”，数据出错导致余数改变——检测到错误。

<img src="../images/image-202511100907.png" style="zoom:50%;" />

<span style="color:#F87B1B">K 个信息位 + R 个检验位</span>作为“<span style="color:#F87B1B">被除数</span>”，添加检验位后需保证除法的余数为 0。

收到数据后，进行<span style="color:#F87B1B">除法</span>检查余数是否为 0。

若余数非 0 则说明出错，则进行重传或纠错。

#### 求解步骤

例题，设生成多项式为 $G(x) = x^3 + x^2 + 1$，信息码为 101001，求对应的 CRC 码。

1. 确定 K、R 以及生成多项式对应的二进制码。

   K = 信息码的长度 = 6，R = 生成多项式最高次幂 = 3。

   $$
   \begin{align*}
   G(x)
   &= x^3 + x^2 + 1 \\
   &= \underline{1} \cdot x^3 + \underline{1} \cdot x^2 + \underline{0} \cdot x^1 + \underline{1} \cdot x^0
   \end{align*}
   $$

   对应二进制码为 <span style="color:#FF3F7F">1101</span>。

2. 移位：

   信息码左移 R 位，低位补 0。

3. 相除：

   对移位后的信息码，用生成多项式进行<span style="color:#FF3F7F">模 2 除法</span>，产生余数。

   <img src="../images/image-202511100921.png" style="zoom:50%;" />

   对应的 CRC 码为 101001<u>001</u>。

4. 检错和纠错：

   发送：101001001，记为：$C_9C_8C_7C_6C_5C_4C_3C_2C_1$。

   接受：101001001，使用约定好的除数 1101 进行模 2 除，余数为 000，代表没有出错。

   接受（出错情况）：1010010<u>1</u>1，使用 1101 进行模 2 除，余数为 010，代表 $C_2$ 出错。（<u>_此处余数和校验码不可直接对应_</u>）

|                     接受                      | 余数 | 出错位 |
| :-------------------------------------------: | :--: | :----: |
| 101001 00<span style="color:#DD0303">0</span> | 001  |   1    |
| 101001 0<span style="color:#DD0303">1</span>1 | 010  |   2    |
| 101001 <span style="color:#DD0303">1</span>01 | 100  |   3    |
| 10100<span style="color:#DD0303">0</span> 001 | 101  |   4    |
| 1010<span style="color:#DD0303">1</span>1 001 | 111  |   5    |
| 101<span style="color:#DD0303">1</span>01 001 | 011  |   6    |
| 10<span style="color:#DD0303">0</span>001 001 | 110  |   7    |
| 1<span style="color:#DD0303">1</span>1001 001 | 001  |   8    |
| <span style="color:#DD0303">0</span>01001 001 | 010  |   9    |

举另外一个例子：

<img src="../images/image-202511101020.png" style="zoom: 50%;" />

对于 K 个信息位与 R 个校验位，若生成多项式选择得当且满足 $2^R \ge K + R + 1$，则 CRC 码可纠正 1 位错。（$K + R$ 代表单比特错误的所有情况，1 表示 1 中正确状态）

> [!tip]
>
> 实际应用中，信息位通常达数千位，检验位仅数个，因此 CRC 码一般仅用于检错。

理论上可以证明循环冗余检验码的检错能力有以下特点：

1. 可检测出所有奇数个错误
2. 可检测出所有双比特错误
3. 可检测出所以小于等于检验位长度的连续错误

---

**知识回顾**：

<img src="../images/image-202511101028.png" style="zoom:67%;" />

### 海明校验码

海明校验码，Hamming Code。

**知识总览**：

<img src="../images/image-202511101313.png" style="zoom: 50%;" />

#### 基本思想

由前文奇偶校验的原理可知，其 1 位检验位仅能判断数据是否出错，无法提供其他额外信息。

**海明码设计思路**：将信息位分组进行偶校验 → 多个校验位 → 多个检验位标注出错位置。

> [!tip]
>
> 多个校验位可承载多种状态信息，包括正误及错误位置。

<img src="../images/image-202511101330.png" style="zoom: 50%;" />

| n   | 1   | 2~4 | 5~11 | 12~26 | 27~57 | 58~120 |
| --- | --- | --- | ---- | ----- | ----- | ------ |
| k   | 2   | 3   | 4    | 5     | 6     | 7      |

#### 求解步骤

<img src="../images/image-202511101335.png" style="zoom: 50%;" />

1. 确认海明码的位数：$2^k \ge n + k + 1$。

   因此有 n = 4 → k = 3，设信息位 $D_4D_3D_2D_1(1010)$，共 4 位；检验位 $P_3P_2P_1$，共 3 位。对应的海明码为 $H_7H_6H_5H_4H_3H_2H_1$。

2. 确认校验位的分布：

   | $H_7$ | $H_6$ | $H_5$ | $H_4$ | $H_3$ | $H_2$ | $H_1$ |
   | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
   | $D_4$ | $D_3$ | $D_2$ | $P_3$ | $D_1$ | $P_2$ | $P_1$ |
   | 1     | 0     | 1     | 0     | 0     | 1     | 0     |

   将校验位 $P_i$ 放到海明位号为 $2^{i - 1}$ 的位置上，信息位按顺序放到其余位置。

3. 求检验位的值：

   $H_3$：3 → 011

   $H_5$：5 → 101

   $H_6$：6 → 110

   $H_7$：7 → 111

   从低到高，第一位为 1 的归为 $P_1$，第二位为 1 的归为 $P_2$，第三位为 1 的归为 $P_3$，以此类推。

   $$
   P_1 = H_3 \oplus H_5 \oplus H_7 = D_1 \oplus D_2 \oplus D_4 = 0 \oplus 1 \oplus 1 = 0 \\
   P_2 = H_3 \oplus H_6 \oplus H_7 = D_1 \oplus D_3 \oplus D_4 = 0 \oplus 0 \oplus 1 = 1\\
   P_3 = H_5 \oplus H_6 \oplus H_7 = D_2 \oplus D_3 \oplus D_4 = 1 \oplus 0 \oplus 1 = 0
   $$

   三个分组，分别求出其偶校验位（即模 2 加）。

4. 纠错：

   校验方程：

   $$
      S_1 = P_1 \oplus D_1 \oplus D_2 \oplus D_4 \\
      S_2 = P_2 \oplus D_1 \oplus D_3 \oplus D_4 \\
      S_3 = P_3 \oplus D_2 \oplus D_3 \oplus D_4
   $$

接收到 1010010（无错误）：

$$
   S_1 = P_1 \oplus D_1 \oplus D_2 \oplus D_4 = 0 \oplus 0 \oplus 1 \oplus 1 = 0\\
   S_2 = P_2 \oplus D_1 \oplus D_3 \oplus D_4 = 1 \oplus 0 \oplus 0 \oplus 1 = 0\\
   S_3 = P_3 \oplus D_2 \oplus D_3 \oplus D_4 = 0 \oplus 1 \oplus 0 \oplus 1 = 0
$$

接收到 10100<u>0</u>0（有错误）：

$$
   S_1 = P_1 \oplus D_1 \oplus D_2 \oplus D_4 = 0 \oplus 0 \oplus 1 \oplus 1 = 0\\
   S_2 = P_2 \oplus D_1 \oplus D_3 \oplus D_4 = \underline{0} \oplus 0 \oplus 0 \oplus 1 = \underline{1}\\
   S_3 = P_3 \oplus D_2 \oplus D_3 \oplus D_4 = 0 \oplus 1 \oplus 0 \oplus 1 = 0
$$

从 $S_1$ 至 $S_3$，由低到高，第 010 位出错（即第 2 位出错）。

<img src="../images/image-202511101434.png" style="zoom:50%;" />

设信息位 $D_1D_2D_3D_4(1010)$，共 4 位；校验位 $P_1P_2P_3$，共 3 位，对应的海明码为 $H_1H_2H_3H_4H_5H_6H_7$。（从小到大）

| $H_1$ | $H_2$ | $H_3$ | $H_4$ | $H_5$ | $H_6$ | $H_7$ |
| ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| $P_1$ | $P_2$ | $D_1$ | $P_3$ | $D_2$ | $D_3$ | $D_4$ |
| 0     | 1     | 0     | 0     | 1     | 0     | 1     |

> [!tip]
>
> 可以结合权重来进行记忆。

#### 补充

海明码的检错、纠错能力：纠错能力——1 位；检错能力——2 位。

可见无法区分到底是 1 位错还是 2 位错。

因此添加“全校验位”，对整体进行偶校验：

| $H_8$  | $H_7$ | $H_6$ | $H_5$ | $H_4$ | $H_3$ | $H_2$ | $H_1$ |
| ------ | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| $P_全$ | $D_4$ | $D_3$ | $D_2$ | $P_3$ | $D_1$ | $P_2$ | $P_1$ |
| 1      | 1     | 0     | 1     | 0     | 0     | 1     | 0     |

$S_3S_2S_1 = 000$ 且全体偶检验成功 → 无错误。

$S_3 S_2 S_1 \neq 000$ 且全体偶校验失败 → 有 1 位错，纠正即可。

$S_3S_2S_1 \neq 000$ 且全体偶校验成功 → 有 2 位错，需重传。

---

**知识总览**：

<img src="../images/image-202511101457.png" style="zoom: 67%;" />

## 流量控制、可靠传输机制

### 滑动窗口机制

<img src="../images/image-202511110002.png" style="zoom: 67%;" />

<img src="../images/image-202511110005.png" style="zoom:80%;" />

窗口“向前滑动”：

<img src="../images/image-202511110009.png" style="zoom: 50%;" />

由接收方通过“<span style="color:#DC0E0E">确认机制</span>”控制发送方的窗口向前滑动，从而实现“<span style="color:#DC0E0E">流量控制</span>”。

### 停止-等待协议（S-W）

**知识总览**：

<img src="../images/image-202511111007.png" style="zoom:67%;" />

停止-等待协议，stop-and-wait。

因为下述条件：

$$
\left\{\begin{matrix}
W_T + W_R \le 2^n \\
W_T = 1 \\
W_R = 1
\end{matrix}\right.
$$

可以得出 n 最小为 1 bit，而后使用 1 bit 进行编号。

> [!tip]
>
> n 指的是给帧进行编号所需的比特数。

<img src="../images/image-202511111023.svg" style="zoom:80%;" />

#### 数据帧、确定帧、帧序号的概念

<img src="../images/image-202511111044.svg"  />

#### “正常”情况示例

发送方发送 0 号数据帧，接收方接收后将数据提交至网络层处理，随后返回 0 号确认帧并滑动接收窗口。此时接收方已准备就绪，可接收 1 号数据帧。

<img src="../images/image-202511111045.webp" style="zoom: 50%;" />

发送方收到 0 号确认帧后，确认接收方已正确接收对应数据，随即向后移动发送窗口。

<img src="../images/image-202511111050.webp" style="zoom: 50%;" />

以此类推，后续按相同流程依次传输后续帧。

<img src="../images/image-202511111054.webp" style="zoom:50%;" />

#### 异常情况示例：数据帧丢失

<img src="../images/image-202511111058.png" style="zoom:50%;" />

<img src="../images/image-202511111058.webp" style="zoom:50%;" />

若传输过程中出现帧丢失（如数据帧或确认帧丢失），发送方在超时计时器到期后，将触发对应帧的重传机制。

<img src="../images/image-202511111101.webp" style="zoom:50%;" />

#### 异常情况示例：确认帧丢失

<img src="../images/image-202511111103.webp" style="zoom:50%;" />

若 1 号确认帧丢失，但接收方已成功接收 1 号数据帧，接收窗口会正常向后滑动（准备接收 0 号数据帧）。

由于发送方未在超时计时器周期内收到 1 号数据帧的对应确定帧，将重传该帧并同步重置超时计时器。

<img src="../images/image-202511111106.webp" style="zoom:50%;" />

#### 探讨：为什么一定要给帧“编号”

若未对帧进行编号，以确认帧丢失的异常场景为例：

发送方因未收到确认帧，超时后会重传对应帧；而接收方<span style="color:#DC0E0E; font-weight:bold">无法判断</span>该重传帧是此前已接收过的**重复帧**，还是新的**待接收帧**。

由于接收窗口和发送窗口的距离不超过 1，因此<span style="color:#DC0E0E">用 1 bit 表示帧序号</span>足矣。

#### 异常情况示例：数据帧有“差错”

<img src="../images/image-202511111123.webp" style="zoom: 50%;" />

<img src="../images/image-202511111124.webp" style="zoom:50%;" />

<img src="../images/image-202511111125.webp" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202511111126.webp" style="zoom:67%;" />

### 后退 N 帧协议（GBN）

**知识总览**：

<img src="../images/image-202511111257.webp" style="zoom:80%;" />

后退 N 帧协议，Go-Back-N。

<img src="../images/image-202511111300.webp" style="zoom:50%;" />

#### “正常”情况示例

<img src="../images/image-202511111302.webp" style="zoom: 50%;" />

发送窗口大小为 3，涵盖了 0、1、2 号帧，发送方可以通过信道连续传输这 3 个帧。

<img src="../images/image-202511111308.webp" style="zoom: 50%;" />

GBN 协议无需为每个帧单独返回 ACK，接收方会持续移动接收窗口接收数据，直至信道无连续传输的数据，之后仅需向发送方返回最后接收帧的 ACK 即可。

> [!tip]
>
> **后退 N 帧协议规定**：接收方可以“<span style="color:#EE6983; font-weight:bold">累计确认</span>”。即连续收到多个数据帧后，<span style="color:#DC0E0E">可以仅返回最后一个帧的 ACK</span>。

发送方收到接收方的 ACK 后，向后移动发送窗口。

#### 异常情况示例：数据帧丢失

<img src="../images/image-202511111325.webp" style="zoom: 50%;" />

<img src="../images/image-202511111331.png" style="zoom:50%;" />

<img src="../images/image-202511111413.webp" style="zoom:50%;" />

**为什么称为“后退 N 帧协议”？**

原本已经发送了 1 号帧，现在却“后退”回 0 号帧重新传送。这样即可实现“流量控制”。

<img src="../images/image-202511111416.webp" style="zoom:50%;" />

<img src="../images/image-202511111437.webp" style="zoom:50%;" />

#### 异常情况示例：确认帧丢失

<img src="../images/image-202511111441.webp" style="zoom:50%;" />

<img src="../images/image-202511111442.webp" style="zoom:50%;" />

<img src="../images/image-202511111444.webp" style="zoom:50%;" />

<img src="../images/image-202511111446.webp" style="zoom:50%;" />

#### 探讨：若不满足 $W_T + W_R \le 2^n$ 会有什么问题？

<img src="../images/image-202511111453.webp" style="zoom:50%;" />

发送方连续往信道上发送序号为 0、1、2、3 的帧。

<img src="../images/image-202511111500.webp" style="zoom:50%;" />

接收方成功接收序号 0、1、2、3 的帧，接收窗口同步滑动至下一帧，但所发送的确认帧发送丢失。

<img src="../images/image-202511111505.webp" style="zoom:50%;" />

可见，若 n 不满足 $W_T + W_R \le 2^n$，重传数据帧的序号可能落入接收窗口，导致接收方误接收。

---

**知识回顾**：

<img src="../images/image-202511111520.webp" style="zoom:67%;" />

### 选择重传协议（SR）

**知识总览**：

<img src="../images/image-202511111556.webp" style="zoom:50%;" />

#### 选择重传协议的窗口大小限制条件

<img src="../images/image-202511111601.webp" style="zoom:50%;" />

选择重传协议的<span style="color:#0046FF">窗口大小需满足如下两个条件</span>：

$$
\left\{\begin{matrix}
W_T + W_R \le 2^n \\
W_R \le W_T
\end{matrix}\right.
$$

若将接收窗口大小改为 4，也符合上述条件：

<img src="../images/image-202511111608.webp" style="zoom:50%;" />

> [!tip]
>
> 当接收窗口大小 $W_R$ 大于发送窗口大小 $W_T$ 时，部分帧序号资源将长期处于空闲状态，进而降低整体信道利用率。
>
> 在实际应用当中，通常取 $W_T = W_R$。

#### “正常”情况示例

<img src="../images/image-202511111622.webp" style="zoom:50%;" />

<img src="../images/image-202511111623.webp" style="zoom:50%;" />

**选择重传协议**规定：接收方可以连续接收多个帧，但<span style="color:#F87B1B">每个帧都需要返回 ACK</span>。

**后退 N 帧协议**规定：接收方可以“<span style="color:#CD2C58; font-weight:bold">累计确认</span>”。即连续收到多个帧时，<span style="color:#CD2C58">可以仅返回最后一个帧的 ACK</span>。

<img src="../images/image-202511111627.webp" style="zoom:50%;" />

#### 异常情况示例：数据帧丢失

<img src="../images/image-202511111629.webp" style="zoom:50%;" />

<img src="../images/image-202511111630.webp" style="zoom:50%;" />

<img src="../images/image-202511111631.webp" style="zoom:50%;" />

<img src="../images/image-202511111632.webp" style="zoom:50%;" />

<img src="../images/image-202511111843.webp" style="zoom:50%;" />

<img src="../images/image-202511111847.webp" style="zoom:50%;" />

<img src="../images/image-202511111849.webp" style="zoom:50%;" />

**选择重传协议如何解决数据帧丢失问题？**

<span style="color:#CD2C58; font-weight:bold">超时重传机制</span>：每个帧被发出时设置<span style="color:#CD2C58">计时器</span>，如果<span style="color:#CD2C58">超时未收到</span>对应的 ACK，就<span style="color:#CD2C58">重传</span>这个帧。

#### 异常情况示例：数据帧因差错而被丢弃

<img src="../images/image-202511111905.webp" style="zoom:50%;" />

<img src="../images/image-202511111906.webp" style="zoom:50%;" />

<img src="../images/image-202511111907.webp" style="zoom:50%;" />

<img src="../images/image-202511111913.png" style="zoom:50%;" />

<img src="../images/image-202511111913.webp" style="zoom:50%;" />

<img src="../images/image-202511111917.webp" style="zoom:50%;" />

<img src="../images/image-202511111918.webp" style="zoom:50%;" />

<img src="../images/image-202511111919.webp" style="zoom:50%;" />

<img src="../images/image-202511111925.webp" style="zoom:50%;" />

**选择重传协议如何解决数据帧因差错而被丢弃问题？**

<span style="color:#4E61D3; font-weight:bold">请求重传</span>机制：如果接收方收到一个有差错的帧，就<span style="color:#4E61D3">将此帧丢弃</span>，并返回对应的<span style="color:#4E61D3">否认帧 NAK_i</span>，主动请求发送方重传 i 号帧。

#### 异常情况示例：确认帧丢失

<img src="../images/image-202511111932.webp" style="zoom:50%;" />

<img src="../images/image-202511111934.webp" style="zoom:50%;" />

<img src="../images/image-202511111937.webp" style="zoom:50%;" />

<img src="../images/image-202511111938.webp" style="zoom:50%;" />

<img src="../images/image-202511111939.webp" style="zoom:50%;" />

<img src="../images/image-202511111940.webp" style="zoom:50%;" />

<img src="../images/image-202511111941.webp" style="zoom:50%;" />

<img src="../images/image-202511111945.webp" style="zoom:50%;" />

#### 探讨：若不满足 $W_T + W_R \le 2^n$ 会有什么问题？

<img src="../images/image-202511111951.png" style="zoom:50%;" />

<img src="../images/image-202511111952.webp" style="zoom:50%;" />

<img src="../images/image-202511111953.webp" style="zoom:50%;" />

<img src="../images/image-202511111954.webp" style="zoom:50%;" />

<img src="../images/image-202511112004.jpg" style="zoom:50%;" />

可见，此时 0 号帧位于接收窗口内，接收方会将重传的 0 号帧误认为是最新的 0 号帧。

> [!tip]
>
> 若不满足 $W_T + W_R \le 2^n$，会导致发送方和接收方无法正确判别“重复帧”。

### 三种协议的信道利用率分析

**知识总览**：

<img src="../images/image-202511112041.webp" style="zoom: 43%;" />

#### S-W 协议的信道利用率

假设信道的数据传输速率为 <span style="color:#8C00FF">1kbps</span>，数据帧长度为 <span style="color:#8C00FF">4kb</span>，确认帧长度为 <span style="color:#8C00FF">1kb</span>，信道单向传输时延为 <span style="color:#8C00FF">7s</span>。

<img src="../images/image-202511112045.webp" style="zoom: 67%;" />
$$
信道利用率 = \frac{4}{4 + 2 + 7 + 1} \approx 21 \%
$$
在 S-W 协议中，理想情况下，有：
$$
U = \frac{T_D}{T_D + RTT + T_A}
$$
理想情况指的就是没有帧丢失、比特错误等异常情况。

> [!tip]
>
> 此处的信道利用率实际指发送方的信道利用率，即发送方将数据帧传输至信道的时间占总时间的比例。

假设确认帧非常短，意味着确认帧的传播时延<u>_可以忽略不计_</u>。

<img src="../images/image-202511112057.webp" style="zoom:50%;" />

此时，有：

$$
信道利用率 = \frac{4}{4 + 2 + 7} \approx 22.2 \%
$$

上文的信道利用率公式中，由于确认帧非常短，可以认为 $T_A = 0$。

---

<img src="../images/image-202511112117.webp" style="zoom:50%;" />
$$
40 \% = \frac{\frac{数据帧长度}{3 \text{kbps}}}{\left(\frac{数据帧长度}{3 \text{kbps}}\right) + 2 \times 200 \text{ms} + 0}
$$
最后得出数据帧的长度为 800bit。

> [!tip]
>
> 上述公式中，需将 ms 换算成 s，才能与前面的 kbps 单位相匹配（实现单位相消）。

#### GBN、SR 协议的信道利用率

假设发送窗口的大小 <span style="color:#DD0303">N 为 4</span>，信道的数据传输速率为 <span style="color:#DD0303">1kbps</span>，数据帧长度为 <span style="color:#DD0303">4kb</span>，确认帧长度为 <span style="color:#DD0303">1kb</span>，信道单向传输时延为 <span style="color:#DD0303">7s</span>。

<img src="../images/image-202511112145.webp" style="zoom:50%;" />

关注灰色虚线框内的周期，有：

$$
信道利用率 = \frac{4 \times 4}{4 + 2 + 7 + 1} \approx 84 \%
$$

理想情况下，有：

$$
信道利用率 = U = \frac{N T_D}{T_D + RTT + T_A}
$$

若发送窗口的大小 <span style="color:#DD0303">N 为 5</span>，其他条件不变，则有：

<img src="../images/image-202511112212.webp" style="zoom:50%;" />

直接代入公式会得到信道利用率大于 1 的结果，而该结果不符合逻辑，因此不可生搬硬套此公式。

经分析可知，与前文示例不同，本案例中一组数据帧（即一个发送窗口的全部帧）**发送完毕的时刻，可能在首个发送帧对应的确认帧返回之后**。

可以看见发送信道上总是有数据通过，此时：

$$
信道利用率 = 1
$$

> [!tip]
>
> 信道利用率不可能超过 1。
>
> 因此对于之前的公式，若 $NT_D \ge T_D + RTT + T_A$，则最大信道利用率为 1。

---

<img src="../images/image-202511112231.webp" style="zoom: 67%;" />

一个数据帧的传播时延为 $\dfrac{1000 \text{B}}{100 \text{Mbps}} = 0.08 \text{ms}$。

<img src="../images/image-202511112237.webp" style="zoom:50%;" />

连续发送 1000 个数据帧耗时 **80ms**。

从发出第一个数据帧到收到第一个确认帧耗时 $2 \times 50 \text{ms} = 100 \text{ms}$。

最大平均数据传输速率为 $\dfrac{1000 \times 1000 \text{B}}{100 \text{ms} + 0.08 \text{ms}} \approx 80 \text{Mbps}$。

信道利用率为 $\dfrac{最大平均数据传输速率}{带宽} \approx 80 \%$。

---

<img src="../images/image-202511112248.webp" style="zoom:50%;" />

对于 GBN 协议、SR 协议，理想情况下，信道利用率为 $\dfrac{N T_D}{T_D + RTT + T_A} \ge 80 \%$。

传输一个数据帧所需时间为 $T_D = \dfrac{1000 \text{B}}{128 \text{kbps}} = 0.0625 \text{s}$。

2 倍的单向传播时延为 $RTT = 2 \times 250 \text{ms} = 0.5 \text{s}$。

而传输一个确认帧的所需时间 $T_A$ 可忽略不计。

最后可以得出 $N \ge 7.2$。

n 相同时，GBN 协议的 $W_T$ 更大，n 至少为 4，才能确保 $W_T \ge 7.2$。

最后得出 $n \ge 4$。

#### 术语补充：滑动窗口协议（Sliding Window Protocol）

<span style="color:#6F00FF; font-weight:bold">原理上</span>，为了便于理解，三者都可以视为采用“滑动窗口机制”。

<img src="../images/image-202511112255.webp" style="zoom:50%;" />

术语使用上，<span style="color:#FF9013; font-weight:bold">S-W 协议<u>不属于</u>“滑动窗口协议”</span>范畴。

<img src="../images/image-202511112257.webp" style="zoom:50%;" />

#### 术语补充：ARQ 协议、连续 ARQ 协议

<span style="color:#DD0303">ARQ 协议</span>——即 Automatic Repeat Request，通常翻译为“自动重传请求”协议，<span style="color:#DD0303">包含 S-W、GBN、SR 三种协议</span>。

<img src="../images/image-202511112304.webp" style="zoom:50%;" />

---

**知识总览**：

<img src="../images/image-202511112320.webp" style="zoom: 67%;" />

## 信道划分介质访问控制

### 什么是“介质访问控制”？

<span style="color:#DC0E0E;font-weight:bold">介质访问控制</span>（Medium Access Control, MAC）：多个节点共享同一个“总线型”广播信道时，可能发生“信号冲突”。

<img src="../images/image-202511121237.webp" style="zoom:50%;" />

如：

- 早期的网络中，常用一条同轴电缆连接多个节点。

  <img src="../images/image-202511121234.webp" style="zoom: 67%;" />

- 用集线器连接多个节点。

- Wi-Fi、5G 等<span style="color:#62109F"><u>无线通讯</u></span>。

**应该怎么控制各节点对传输介质的访问，才可减少冲突，甚至避免冲突？**

这就是<u>介质访问控制</u>需要解决的问题。

### 信道划分

**知识总览**：

<img src="../images/image-202511121240.webp" style="zoom:50%;" />

#### 时分复用（TDM）

<img src="../images/image-202511121241.webp" style="zoom:50%;" />

<img src="../images/image-202511121243.webp" style="zoom:50%;" />

---

<img src="../images/image-202511121246.webp" style="zoom:50%;" />

**时分复用（Time Division Multiplexing, TDM）**——将时间分为<span style="color:#A72703; font-weight:bold">等长的“TDM 帧”</span>，每个“TDM 帧”又分为<span style="color:#A72703; font-weight:bold">等长的 m 个“时隙”</span>，将 m 个时隙分配给 m 对用户（节点）使用。

<img src="../images/image-202511121249.webp" style="zoom:50%;" />

**TDM 的缺点**：

- 每个节点<span style="color:#4A70A9"><u>最多</u>只能分配到信道总带宽的 $\dfrac{1}{m}$</span>。
- 如果某节点暂不发送数据，会导致被分配的“时隙”闲置，<span style="color:#4A70A9">信道利用率低</span>。

**如何解决？**

可<span style="color:#016B61; font-weight:bold">统计</span>每个节点对信道的使用需求，<span style="color:#016B61; font-weight:bold">动态按需分配时隙</span>。

#### 统计时分复用（STDM）

<span style="color:#41A67E; font-weight:bold">统计时分复用</span>（Statistic Time Division Multiplexing, **STDM**）——又称<span style="color:#41A67E; font-weight:bold">异步时分复用</span>，在 TDM 的基础上，<span style="color:#41A67E">动态按序分配时隙</span>。

<img src="../images/image-202511121258.webp" style="zoom:50%;" />

**STDM 的优点**：

- 若需要时，一个节点可以在一段时间内<span style="color:#E45A92; font-weight:bold">获得所有的信道带宽资源</span>
- 若某节点暂不发送数据，可以不分配“时隙”，<span style="color:#E45A92; font-weight:bold">信道利用率更高</span>

#### 频分复用（FDM）

<img src="../images/image-202511121259.webp" style="zoom:50%;" />

<span style="color:#0046FF; font-weight:bold">结论</span>：若两个信号频率接近，就很难“分辨”出来。

<img src="../images/image-202511121306.webp" style="zoom:50%;" />

<span style="color:#FEB21A; font-weight:bold">结论</span>：如果两个信号频率区别很大，就很容易“分辨”出来。

<img src="../images/image-202511121309.webp" style="zoom:50%;" />

<img src="../images/image-202511121310.webp" style="zoom:50%;" />

---

<img src="../images/image-202511121314.webp" style="zoom:50%;" />

<span style="color:#E45A92; font-weight:bold">频分复用</span>（Frequency Division Multiplexing, **FDM**）是<span style="color:#B45253">将信道的<u>总频带</u>分为多个<u>子频带</u></span>，每个子频带作为一个子信道，每对用户使用一个子信道进行通信。

**FDM 的优缺点**：

- 优点：各节点可同时发送信号；充分利用了信道带宽（Hz）
- 缺点：FDM 技术<span style="color:#DC143C">只能用于模拟信号</span>的传输

#### 波分复用（WDM）

<span style="color:#5682B1; font-weight:bold">波分复用</span>（Wavelength Division Multiplexing, **WDW**）——即<span style="color:#8FA31E; font-weight:bold">光的频分复用</span>。

<img src="../images/image-202511121323.webp" style="zoom:50%;" />

> [!tip]
>
> 光信号的频带范围（带宽）非常大，因此很适合采用波分复用技术，将一根光纤在逻辑上拆分为多个子信道。

#### 码分复用（CDM）

<img src="../images/image-202512212108.jpg" style="zoom: 50%;" />

**背景**：2G、3G 移动网络时代，节点和节点之间的通信常使用 <span style="color:#FF4646">CDMA</span>（Code Division Multiple Access）技术。

> [!tip]
>
> CDMA 的底层原理就是<span style="color:#16476A">码分复用</span>（Code Division Multiplexing, <span style="color:#E9762B">CDM</span>）。

<img src="../images/image-202512212109.png" style="zoom: 50%;" />

##### 各节点用专属“码片序列”发送数据

<img src="../images/image-202512212112.png" style="zoom: 50%;" />

<img src="../images/image-202512212119.png" style="zoom:50%;" />

<img src="../images/image-202512212121.png" style="zoom: 50%;" />

<img src="../images/image-202512212124.png" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202512212125.png" style="zoom:67%;" />

## 随机访问介质访问控制

**知识总览**：

<img src="../images/image-202512212148.png" style="zoom:50%;" />

### 纯 ALOHA、时隙 ALOHA

<img src="../images/image-202512212157.png" style="zoom:50%;" />

<img src="../images/image-202512212202.png" style="zoom:50%;" />

<img src="../images/image-202512212218.png" style="zoom:50%;" />

### CSMA 协议

<span style="color:#FFA239; font-weight:bold">CSMA</span>（Carrier Sense Multiple Access）协议，即<span style="color:#AA2B1D">载波<span style="font-weight:bold">监听</span>多路访问协议</span>。

CSMA 协议在 ALOHA 协议基础上提出改进：<span style="color:#00B7B5">在发送数据之前，先监听信道是否空闲，只有信道空闲时，才会尝试发送</span>。

<img src="../images/image-202512212247.png" style="zoom:50%;" />

> [!tip]
>
> - **ALOHA 协议**：一群无礼匹夫的对话，有话直说，**完全不管别人是否在说话**。
> - **CSMA 协议**：一群有礼貌的人的对话，**说话前先听听别人是否在说话**。

#### 1-坚持 CSMA 协议

<img src="../images/image-202512212337.png" style="zoom:50%;" />

- **优点**：信道利用率高，信道一旦空闲，就可以被下一个节点使用。
- **缺点**：当多个节点均准备好数据时，一旦信道空闲，会有多个节点同时发送数据，冲突概率大。

#### 非坚持 CSMA 协议

<img src="../images/image-202512212322.png" style="zoom:50%;" />

- **优点**：当多个节点均准备好数据时，若信道不空闲，则各节点会***随机推迟一段时间再尝试监听***，从而使**各节点“错开”发送数据**，降低冲突概率。
- **缺点**：信道刚恢复空闲时，可能不会被立即利用，导致信道利用率下降。

#### p-坚持 CSMA 协议

<img src="../images/image-202512220903.png" style="zoom:50%;" />

**优点**：属于 1-坚持 CSMA、非坚持 CSMA 的折中方案，降低冲突概率的同时，提升信道利用率。

---

**知识回顾**：

<img src="../images/image-202512220909.png" style="zoom: 67%;" />

### CSMA/CD 协议

**知识总览**：

<img src="../images/image-202512220912.png" style="zoom:50%;" />

<img src="../images/image-202512220915.png" style="zoom:50%;" />

#### CSMA/CD 协议要点

<img src="../images/image-202512220929.png" style="zoom:50%;" />

> [!tip]
>
> 在 CSMA/CD 中，**CD** 是 **Collision Detection** 的缩写，中文意思是**冲突检测**。

#### CSMA/CD 协议（发送方）

<img src="../images/image-202512220933.png" style="zoom:50%;" />

#### CSMA/CD 协议的“争用期”

<img src="../images/image-202512221013.png" style="zoom:50%;" />

- **问题 1：若 A 节点往信道上发送数据，最多需要多久可以被其他所有节点“监听”到信号？**30μs。
- **问题 2：显然，A 节点往信道上发送的数据可能与其他节点发生“冲突”。那么在最极限的情况下，从 A 节点发出数据开始，<u>*最多需要多久*</u>，A 节点<u>*一定可以检测到冲突*</u>？**2 × 30μs = 60μs。

<img src="../images/image-202512221041.png" style="zoom:50%;" />

#### CSMA/CD 协议“最短帧长”限制

<img src="../images/image-202512221056.png" style="zoom:50%;" />

<img src="../images/image-202512221058.png" style="zoom:50%;" />

若 A 节点发送的数据帧长度小于 600bit，可能会导致 A 节点**“误以为”发送过程中没有发生冲突，但实际上已经发生了冲突**。

若实际要发送的**数据很少，可“填充”至合法长度后再发送**。

#### CSMA/CD 协议（接收方）

<img src="../images/image-202512221107.png" style="zoom:50%;" />

#### CSMA/CD 协议“最长帧长”限制

<img src="../images/image-202512221113.png" style="zoom:50%;" />

### CSMA/CA 协议

**知识总览**：

<img src="../images/image-202512221221.png" style="zoom:50%;" />

> [!tip]
>
> 在 CSMA/CA 中，**CA** 是 **Collision Avoidance** 的缩写，中文意思是**冲突避免**。

- **CMCA**：先监听，若信道空闲，再发送。
- **CSMA/CD**：边发送边监听，检测到冲突立即停发。（适用于<u>有线</u>网络，例如以太网技术）
- **CSMA/CA**：发送过程中不用检测冲突，发送前想办法尽量避免冲突（但无法完全避免）。（适用于<u>无线</u>网络，例如 IEEE 802.11 标准的无线局域网技术，即 Wi-Fi）

#### AP 的定义

**AP（Access Point）——接入点**，也就是平时连接的无线 Wi-Fi 热点。

<img src="../images/image-202512221236.png" style="zoom:50%;" />

<img src="../images/image-202512221240.png" style="zoom:50%;" />

切换 Wi-Fi 热点的动作称之为**漫游**。

<img src="../images/image-202512221242.png" style="zoom:50%;" />



#### 无线局域网（Wi-Fi）面临的新问题

所有**移动站点**（A–D）均需通过**固定站点** AP 进行通信。（接入点 AP 通常被称为固定站点，以区别于移动站点。）

<img src="../images/image-202512221234.png" style="zoom:50%;" />

**为什么不采用 CSMA/CD 协议？**

1. **硬件上很难实现“边听边发，冲突检测”**——因为接受信号的强度往往远小于发送信号的强度，且在无线介质上信号强度的动态变化范围很大。
1. **存在“隐蔽站”问题**——在无线通讯中，并非所有站点都可听见对方。发送节点处没有冲突并不意味着接收节点处就没有冲突。（例如 A 无法监听到 B、C 的信号，B、C 对于 A 而言就是“隐蔽站”）

#### CSMA/CA 协议要点（暂不考虑“隐蔽站”问题）

<img src="../images/image-202512222021.png" style="zoom:50%;" />

<img src="../images/image-202512222241.png" style="zoom:50%;" />

<span style="font-weight:bold">帧间间隔（<span style="color:#FF4646">I</span>nter <span style="color:#FF4646">F</span>rame <span style="color:#FF4646">G</span>ap）</span>：

- **DIFS（分布式协调 IFS）**：最长的帧间间隔。
- **SIFS（短 IFS）**：最短的帧间间隔；预留 SIFS 用于处理收到的帧（如完成差错控制等）。

#### 解决“隐蔽站”问题

<img src="../images/image-202512222308.png" style="zoom:50%;" />

<img src="../images/image-202512222310.png" style="zoom:50%;" />

> [!tip]
>
> - 若超时未收到 CTS，说明预约失败，则“随机退避”后再次 RTS 访问。
> - “先预约，再发送”这种模式可以启用，也可以不启用。

**RTS 控制帧**（Request To Send，**请求发送**）——它包括源地址、目的地址和这次通信所需的**持续时间**。

**CTS 控制帧**（Clear To Send，**允许发送**）——它也包括源地址、目的地址和这次通信所需的**持续时间**。

---

<img src="../images/image-202512230007.png" style="zoom:50%;" />

<img src="../images/image-202512230008.png" style="zoom:50%;" />

## 轮询访问介质访问控制

### 令牌传递协议

#### 历史背景

**令牌环网技术**：IBM 公司于 1984 开发的一种局域网技术。

<span style="color:#AA2B1D; font-weight:bold">核心特点</span>：环形拓扑结构，各节点“轮询访问”信道，<span style="color:#AA2B1D">不会发生信道冲突</span>。

如何实现“介质访问控制”：<span style="color:#5A9CB5">令牌传递协议</span>。

<img src="../images/image-202512230023.png" style="zoom:50%;" />

#### 令牌传递协议的工作原理

<img src="../images/image-202512230028.png" style="zoom:50%;" />

<img src="../images/image-202512230035.png" style="zoom:50%;" />

<img src="../images/image-202512230043.png" style="zoom:50%;" />

节点检查目的地址是否与自己相同，若相同，就复制数据部分，并将数据帧标记为“已接收”。

<img src="../images/image-202512230933.jpg" style="zoom:50%;" />

<img src="../images/image-202512230934.webp" style="zoom:50%;" />

<img src="../images/image-202512230936.webp" style="zoom:50%;" />

<img src="../images/image-202512230939.webp" style="zoom:50%;" />

> [!tip]
>
> 每次只能传一个帧，传完就要释放新令牌（生成一个新令牌）。

<img src="../images/image-202512230940.webp" style="zoom:50%;" />

<img src="../images/image-202512230942.webp" style="zoom:50%;" />

<img src="../images/image-202512230948.webp" style="zoom:50%;" />

> [!tip]
>
> 无论是令牌帧还是数据帧，都只能沿单向传递。

#### 令牌帧、数据帧

<img src="../images/image-202512230951.webp" style="zoom:50%;" />

#### MAU——令牌环网的集中控制站

**MAU**（Multistation Access Units，多站接入单元），用于集中控制“令牌环网”。

<img src="../images/image-202512230956.webp" style="zoom:50%;" />

<img src="../images/image-202512230959.webp" style="zoom:50%;" />

---

**知识回顾**：

<img src="../images/image-202512231001.webp" style="zoom:50%;" />

## 局域网 & IEEE 802

**知识总览**：

<img src="../images/image-202512231111.webp"  />

## 局域网的基本概念和体系结构

<img src="../images/image-202512231504.svg"  />

> [!tip]
>
> 并不是所有网线都会使用 **4 对双绞线**（支持**全双工**通信），早期的网线**只包含 1 对双绞线** （只能支持**半双工**通信）。

## 以太网和 IEEE 802.3

### IEEE 802 的层次划分

<img src="../images/image-202512231541.webp" style="zoom:50%;" />

### IEEE 802.3 推出的以太网标准（物理层）

<img src="../images/image-202512231543.webp" style="zoom:50%;" />

**重点关注**：支持<span style="color:#360185; font-weight:bold">全双工</span> or <span style="color:#DE1A58; font-weight:bold">半双工</span>？

- <u>同轴电缆</u>只能<span style="color:#DE1A58; font-weight:bold">半双工</span>
- <u>双绞线</u>
  - 速率 < 2.5Gbps 可支持<span style="color:#DE1A58; font-weight:bold">半双工</span> or <span style="color:#360185; font-weight:bold">全双工</span>（节点连接时协商）
  - 速率 ≥ 2.5Gbps 仅支持支<span style="color:#360185; font-weight:bold">全双工</span>
- <u>光纤</u>只支持<span style="color:#360185; font-weight:bold">全双工</span>

### 同轴电缆以太网（中继器连接）

<img src="../images/image-202512231731.webp" style="zoom:50%;" />

> [!tip]
>
> 不同的网段可以采用不同的标准，<u>同轴电缆网段仅支持**半**双工</u>。

### 双绞线以太网（交换机/集线器连接）
<img src="../images/image-202512231733.webp" style="zoom:50%;" />

> [!tip]
>
> - 一般而言，默认**交换机**连接的<u>终端</u>节点都可以*全双工*。
> - 用**集线器**连接的节点，仅支持*半双工*模式。

### 两种常见的以太网 MAC 层标准

<img src="../images/image-202512231741.webp" style="zoom:50%;" />

### V2 标准的以太网 MAC 帧

<img src="../images/image-202512231750.webp" style="zoom:50%;" />

### IEEE 802.3 标准的以太网 MAC 帧

<img src="../images/image-202512231746.webp" style="zoom:50%;" />

### 回顾：曼彻斯特编码

<img src="../images/image-202512231815.webp" style="zoom:50%;" />

以太网 MAC 帧结束定界——违规编码法：

在曼彻斯特编码中，若信号中间不跳变，就属于“违规编码”，当接收方检测到违规编码时，就知晓帧已经结束。

### 重点：单播帧、广播帧如何传播？

<img src="../images/image-202512231818.webp" style="zoom:50%;" />

> [!tip]
>
> MAC 地址是数据链路层的概念。
>
> <span style="color:#CF0F0F">路由器</span>、<span style="color:#E97F4A">交换机</span><span style="color:#3291B6">都有 MAC 地址</span>，而<span style="color:#6DC3BB">集线器</span><span style="color:#5459AC">没有 MAC 地址</span>。

- **单播帧**：
  - **A → C**：仅 C 能收到并接收帧。
  - **A → F**：E、F、G 能收到，仅 F 会接收帧。
  - **E → A**：F、G、A 能收到，仅 A 会接收帧。
  - **E → F**：F、G 能收到，仅 F 会接收帧。
- **广播帧（目的地址全为 1）**：
  - A 发出广播帧，B、C、D、E、F、G、R 都能收到并接收帧。
  - E 发出广播帧，A、B、C、D、F、G、R 都能收到并接收帧。

> [!tip]
>
> 路由器 R 收到广播帧后，**不会再转发至其他网络**。只有同一个局域网内的各节点才属于同一个“广播域”。

### 冲突域、广播域

<img src="../images/image-202512231839.webp" style="zoom:50%;" />

- <span style="color:#FF6C0C; font-weight:bold">冲突域</span>：如果两个节点同时发送数据，会导致冲突，则二者处于同一个“<span style="color:#FF6C0C">冲突域</span>”。
- <span style="color:#FF6C0C; font-weight:bold">广播域</span>：如果一个节点发送广播帧，可以被另一个节点接收，则二者处于同一个“<span style="color:#FF6C0C">广播域</span>”。

> [!tip]
>
> - **以太网交换机**隔离**冲突域**，但不隔离**广播域**。
> - **路由器**既隔离**冲突域**，也隔离**广播域**。
> - **集线器**既不隔离**冲突域**，也不隔离**广播域**。

---

**知识回顾**：

<img src="../images/image-202512231846.webp" style="zoom:50%;" />

## VLAN（虚拟局域网）

### 一个大型局域网（如校园网）面临的问题

<img src="../images/image-202512231858.webp" style="zoom:50%;" />

1. 局域网内任何一个节点发出的广播帧，都会被广播至所有节点。可能出现“广播风暴”。
2. 不安全，局域网内可能会有一些敏感节点。

### VLAN（虚拟局域网）

<img src="../images/image-202512231902.webp" style="zoom:50%;" />

- 可将一个大型局域网分割成若干个较小的 VLAN，<span style="color:#FF5555; font-weight:bold">每个 VLAN 是一个广播域</span>。
- 需要使用<u>支持 VLAN 功能的以太网交换机</u>来实现。
- 每一个 VLAN 对应一个 <span style="color:#001BB7; font-weight:bold">VID</span>。

### VLAN 划分方式：基于接口

<img src="../images/image-202512231919.webp" style="zoom:50%;" />

### VLAN 划分方式：基于 MAC 地址

<img src="../images/image-202512231929.webp" style="zoom:50%;" />

### VLAN 划分方式：基于 IP 地址

<img src="../images/image-202512231933.webp" style="zoom:50%;" />

> [!tip]
>
> 这种方式<span style="color:#A72703">可以让 VLAN 范围跨越路由器，让多个局域网的主机组成一个 VLAN</span>（需要<span style="color:#4E61D3">网络层</span>功能支持）。

### 802.1Q 帧的作用

<img src="../images/image-202512231938.webp" style="zoom:50%;" />

- <span style="color:#001BB7; font-weight:bold">主机</span>与<span style="color:#FF8040; font-weight:bold">交换机</span>之间，传输<span style="color:#8C00FF">标准以太网帧</span>。
- <span style="color:#FF8040; font-weight:bold">交换机</span>与<span style="color:#FF8040; font-weight:bold">交换机</span>之间，传输 <span style="color:#5A9690">802.1Q 帧</span>。

### 802.1Q 帧的结构

在<span style="color:#8C00FF">标准以太网帧</span>的源地址之后，插入 VLAN 标签，得到 <span style="color:#5A9690">802.1Q 帧</span>。

<img src="../images/image-202512231949.webp" style="zoom:50%;" />

- <span style="color:#8C00FF; font-weight:bold">标准以太网帧</span>——6 6 2 N 4，收发协数验。
- <span style="color:#5A9690; font-weight:bold">802.1Q 帧</span>——6 6 <span style="color:#5A9690">4</span> 2 N 4，收发 <span style="color:#5A9690">V</span> 协数验。

---

<img src="../images/image-202512232002.webp" alt="image-202512232002" style="zoom:50%;" />

## IEEE 802.11 无线局域网

**知识总览**：

<img src="../images/image-202512232007.webp" style="zoom:50%;" />

<img src="../images/image-202512232009.webp" style="zoom:50%;" />

<img src="../images/image-202512232010.webp" style="zoom:50%;" />

### 一个普通家用路由器的硬件架构

<img src="../images/image-202512232011.webp" style="zoom:50%;" />

<img src="../images/image-202512232014.webp" style="zoom:50%;" />

### 802.11 无线局域网的基本概念

<img src="../images/image-202512232016.webp" style="zoom:50%;" />

- <span style="color:#5D866C">802.11 无线局域网</span>是<span style="color:#5D866C">星形拓扑</span>，中心称为<span style="color:#696FC7">接入点（AP）</span>，也可称为<span style="color:#696FC7">无线接入点（WAP）</span>。（即日常生活中连接的 Wi-Fi 热点）

- <span style="color:#FA812F">基本服务集 BSS</span>：1 个<u>基站</u>（AP）+ 多个移动站。（一个 Wi-Fi 热点连接了很多台手机、电脑等设备）

  - <span style="color:#C66E52">服务集标识符 SSID</span>：也就是无线局域网的名字，不超过 32 字节。（Wi-Fi 的名字）
  - <span style="color:#DD7BDF">基本服务区 BSA</span>：指一个基本服务集能够覆盖的地理范围。（位于什么位置可以搜索到 Wi-Fi）


- 门户（Portal）：可将 802.11 无线局域网接入 802.3 有线以太网。
- <span style="color:#BF092F">拓展服务集 ESS</span>：将多个 AP 连接到同一个<u>分配系统</u>，组成一个更大的服务集。（即后文提到的全屋 Wi-Fi）
- <span style="color:#2F5755">漫游</span>：一个移动站从一个基本服务集切换到另一个基本服务集，仍然可以保持通信。（丝滑地切换 Wi-Fi 热点）

### 想要 Wi-Fi 信号好？一一安装全屋 Wi-Fi

<img src="../images/image-202512232039.webp" style="zoom:50%;" />

安装步骤：

1. 母路由器 WAN 口连接网络运营商
2. 母路由器 3 个 LAN 口用网线连接 3 个子路由器
3. 把 3 个子路由器布置到家里各个角落

<img src="../images/image-202512232040.webp" style="zoom:50%;" />

### 什么是“漫游”？

<img src="../images/image-202512232120.gif" style="zoom:50%;" />

### 802.11 帧的分类

1. <span style="color:#1E93AB">数据帧</span>
2. <span style="color:#1E93AB">控制帧</span>：如 ACK、RTS、CTS 帧
3. <span style="color:#1E93AB">管理帧</span>：如探测请求帧/探测响应帧（用于发现 Wi-Fi）

<img src="../images/image-202512232121.webp" style="zoom:50%;" />

### 802.11 局域网的数据帧格式

<img src="../images/image-202512232130.webp" style="zoom:50%;" />

> [!tip]
>
> 在 802.11 无线局域网内，2 个移动站之间<u>**不能直接通信**</u>，必须通过基站（AP）转发。
>
> <img src="../images/image-202512232133.webp" style="zoom:50%;" />

<img src="../images/image-202512232140.webp" style="zoom:50%;" />

---

<img src="../images/image-202512232230.webp" style="zoom:50%;" />

- <u>802.11 帧</u>格式用于<u>无线链路</u>传输，通常是 AP 与移动站之间的传输。
- 在<u>有线链路</u>上通常使用<u>以太网帧</u>格式，AP 与 AP 之间、AP 与路由器之间、AP 与以太网交换机之间使用有线链路。

> [!tip]
>
> AP 通常具备“帧格式转换”的功能。
>
> 可以将在无线链路上传输的 <u>802.11 帧</u>格式，与有线链路上传输的<u>以太网帧</u>格式相互转换。

---

**知识回顾**：

<img src="../images/image-202512232249.webp" style="zoom:50%;" />

### 拓展：RTS、CTS、ACK 帧格式

<img src="../images/image-202512232304.webp" style="zoom:50%;" />

持续期字段，用于表示在本帧结束后还需占用信道多少时间（以微秒为单位）。

## 广域网

## 以太网交换机

**知识总览**：

<img src="../images/image-202512232311.webp" style="zoom:50%;" />

### 以太网交换机的自学习功能

<img src="../images/image-202512232316.webp" style="zoom:50%;" />

<img src="../images/image-202512232328.webp" style="zoom:50%;" />

**思考：若 H 节点拔掉网线，换到交换机 1 - 端口 7，会发生什么？如何解决？**

<img src="../images/image-202512232329.webp" style="zoom:50%;" />

设置每个**表项**的有效期，**过期自动作废**。

<img src="../images/image-202512232332.webp" style="zoom:50%;" />

### 交换机：直通交换 vs. 存储转发交换

<img src="../images/image-202512232334.webp" style="zoom:50%;" />

<img src="../images/image-202512232344.webp" style="zoom:50%;" />

<span style="color:#67C090; font-weight:bold">直通交换</span>：交换机仅需接受并处理目的地址（6 字节，48bit）。

接受 48bit 所需时间至少为 48b/100Mbps = 0.48μs。

